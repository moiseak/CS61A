
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="description" content ="CS 61A: Structure and Interpretation of Computer Programs" />
    <meta name="keywords" content ="CS 61A, Computer Science, CS, 61A, Programming, John DeNero, Berkeley, EECS" />
    <meta name="author" content ="Laryn Qi, Charlotte Le, Raymond Tan" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-throttle-debounce/1.1/jquery.ba-throttle-debounce.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="../../assets/js/hl.js"></script>
    <script src="../../assets/js/toggledarkmode.js"></script>
    <script>
        // we aren't registering builtins since
        //      (1) they don't render differently in the current CSS from other names
        //      (2) it's a mess to list all of them. You can extract from the site but that takes effort
        // if (1) ceases to be true, (2) might be worth the effort. For now, we're leaving as is
        hljsRegister({
            'keyword': "define if cond and or let begin lambda mu quote delay cons-stream set! quasiquote unquote unquote-splicing define-macro"
        });
        hljs.initHighlightingOnLoad();
    </script>
    <script src="../../assets/js/dark-mode.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata|Roboto:300,400,500|Work+Sans:400,700">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/mono-blue.css">
    <link rel="icon" href="../../assets/images/favicon.ico">

    

<link href="../../assets/css/project.css" rel="stylesheet" type="text/css">


    <title>
Project 4: Scheme Interpreter | CS 61A Summer 2024
</title>
  </head>

  <body id="index" class="home">
    <nav class="navbar navbar-default navbar-static-top">
      <div class="container noselect">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-section">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../index.html">
            <img style="max-width:60px; margin-top: -20px;" class="logo" src="../../assets/images/logo.png"/>
          </a>
        </div>

        <div class="collapse navbar-collapse" id="navbar-collapse-section">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="../../office-hours.html">Weekly Schedule</a></li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="../scheme.html#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                External Websites
                <span class="caret"></span>
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                <li><a href="https://oh.cs61a.org/">Office Hours Queue</a></li>
                <li><a href="https://pythontutor.com/cp/composingprograms.html">Python Tutor</a></li>
                <li><a href="https://code.cs61a.org/">Online Code Editor</a></li>
                <li><a href="https://www.composingprograms.com/">Textbook</a></li>
                <li><a href="https://edstem.org/us/courses/59836/discussion/">Ed</a></li>
                <li><a href="https://sections.cs61a.org">Sections Tool</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="../scheme.html#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Forms
                <span class="caret"></span>
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                <li><a href="https://go.cs61a.org/extensions">Request an Extension</a></li>
                <li><a href="https://go.cs61a.org/regrades">Request a Regrade</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="../scheme.html#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Resources
                <span class="caret"></span>
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                <li><a href="https://go.cs61a.org/debugging-guide">Debugging Guide</a></li>
                <li><a href="../../articles/studying.html">Studying Guide</a></li>
                <li><a href="../../articles/composition.html">Composition Guide</a></li>
                <li><a href="../../articles/pair-programming.html">Pair Programming Guide</a></li>
                <li><a href="../../resources.html">Past Exams & Websites</a></li>
                <li><a href="../../articles/campus-res/index.html">Department and Campus</a></li>
                <li><a href="../../articles/advice/index.html">Advice from Former Students</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="../scheme.html#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Staff
                <span class="caret"></span>
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                <li><a href="../../instructor.html">Instructors</a></li>
                <li><a href="../../staff.html">TAs & Tutors</a></li>
                <li><a href="../../contact/index.html">Contact</a></li>
              </ul>
            </li>
            <li><a href="../../articles/about.html">Syllabus</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <main id="content" class="container">
      
<div class='row'>
  <div class='col-md-9'>
    <header>
      <h1>
        
Project 4: Scheme Interpreter

        
        
        <ul class="inline-block list-inline">
          <li><a href="scheme.zip" class="label label-outline">scheme.zip</a></li>
        </ul>
        
        
      </h1>
    </header>
    
<div class="haiku">
  <blockquote><p><img class="img-responsive center-block" src="images/money_tree.png" alt="Money Tree" width="" height=""></p>

<cite>
  Eval calls apply,<br />
  which just calls eval again!<br />
  When does it all end?
</cite></blockquote>
</div>

    

<h2 id="introduction">Introduction</h2>


<!-- blockquote hack -->

<blockquote><p><strong>Important submission note</strong>: For full credit,</p>

<ul>
  <li>Submit with Parts 1 and 2 complete by <strong>Wednesday, July 31</strong> (worth 1 pt).</li>
  <li>Submit with all phases complete by <strong>Tuesday, August 6</strong>.
  Try to attempt the problems in order, as some later problems will depend
  on earlier problems in their implementation and therefore also when
  running <code>ok</code> tests.</li>
</ul>

<p>The entire project can be completed with a partner.</p>

<p>You can get 1 EC point by submitting the entire project by
<strong>Monday, August 5</strong>.</p></blockquote>

<p>In this project, you will develop an interpreter for a subset of the Scheme
language <em>using Python</em>. As you proceed, think about the issues that arise in the design of a
programming language; many quirks of languages are byproducts of implementation
decisions in interpreters and compilers. The subset of the language used in this
project is described in the <a href="https://www.composingprograms.com/pages/32-functional-programming.html">functional programming</a> section of Composing
Programs, as well as this <a href="../../articles/scheme-spec/index.html">language specification</a> and
<a href="../../articles/scheme-builtins/index.html">built-in procedure reference</a>.</p>

<p>You may find the lecture on Interpreters helpful for
this project.</p>

<!-- In addition, there will be a completely optional open-ended art contest
(released separately) that challenges you to produce recursive images in only a
few lines of Scheme. As an example, the picture above abstractly depicts all the
ways of making change for $0.50 using U.S. currency. All flowers appear at the
end of a branch with length 50. Small angles in a branch indicate an additional
coin, while large angles indicate a new currency denomination. In the contest,
you too will have the chance to unleash your inner recursive artist. -->

<!-- For this project, we are releasing an alternative challenge version of the project, which
provides much less guidance in the project specification as well as a minimal
amount of starter code. It is appropriate for students with a substantial amount
of coding experience who want a rather challenging project. It will be
worth no more points than the standard version, but can be completed instead of
the standard version for full credit. -->

<!--
-->


<h2 id="download-starter-files">Download starter files</h2>


<p>You can download all of the project code as a <a href="scheme.zip">zip archive</a>.</p>

<p>Files you will edit:</p>

<ul>
  <li><code>scheme_eval_apply.py</code>: the recursive evaluator for Scheme expressions</li>
  <li><code>scheme_forms.py</code>: Python functions for evaluating special forms in Scheme (such as <code>define</code>, <code>lambda</code>, <code>and</code>, <code>cond</code>, etc.)</li>
  <li><code>scheme_classes.py</code>: Python classes that describe Scheme expressions</li>
  <li><code>questions.scm</code>: Scheme procedures for you to implement (similar to lab and homework questions)</li>
</ul>

<p>The rest of the files in the project:</p>

<ul>
  <li><code>scheme.py</code>: the interpreter REPL (aka the user interface to the interpreter)</li>
  <li><code>pair.py</code>: defines the <code>Pair</code> class and the <code>nil</code> object</li>
  <li><code>scheme_builtins.py</code>: built-in Scheme procedures</li>
  <li><code>scheme_reader.py</code>: the reader for Scheme input
  <!--  (this file is obfuscated because you will implement it in lab) --></li>
  <li><code>scheme_tokens.py</code>: the tokenizer for Scheme input</li>
  <li><code>scheme_utils.py</code>: functions for inspecting Scheme expressions</li>
  <li><code>ucb.py</code>: utility functions for use in 61A projects</li>
  <li><code>tests.scm</code>: a collection of test cases written in Scheme</li>
  <li><code>ok</code>: the autograder</li>
  <li><code>tests</code>: a directory of tests used by <code>ok</code></li>
  <li><code>mytests.rst</code>: a file where you can add your own tests</li>
</ul>




<!-- This is a hack so this section shows up in the sidebar -->

<h2 id="logistics">Logistics</h2>



<!-- <p>Remember that you can earn an additional bonus point by submitting the
  project at least 24 hours before the deadline.</p> -->



<p>The project is worth 31 points.
30 points are for correctness,
1 point is for submitting Parts 1 &amp; 2 by the first checkpoint date.</p>

<p>You can get 1 EC point for submitting the entire project by Monday, August 5.
You can get 4 additional EC points by completing the optional EC question.</p>


<p>You will turn in the following files:</p>

<ul>
  <li><code>scheme_eval_apply.py</code></li>
  <li><code>scheme_forms.py</code></li>
  <li><code>scheme_classes.py</code></li>
  <li><code>questions.scm</code></li>
</ul>

<p>You do not need to modify or turn in any other files to complete the
project. To submit the project, <b> submit the required files to the appropriate Gradescope assignment.</b></p>

<p>For the functions that we ask you to complete, there may be some
initial code that we provide. If you would rather not use that code,
feel free to delete it and start from scratch. You may also add new
function definitions as you see fit.</p>

<p><b>However, please do not modify any other functions or edit any files not
listed above</b>. Doing so may result in your code failing our autograder tests.
Also, please do not change any function signatures (names, argument order, or
number of arguments).</p>



<p>Throughout this project, you should be testing the correctness of your code.
It is good practice to test often, so that it is easy to isolate any problems.
However, you should not be testing <i>too</i> often, to allow yourself time to
think through problems.</p>

<p>We have provided an <b>autograder</b> called <code>ok</code> to help you
with testing your code and tracking your progress. The first time you run the
autograder, you will be asked to <b>log in with your Ok account using your web
browser</b>. Please do so. Each time you run <code>ok</code>, it will back up
your work and progress on our servers.</p>

<p>The primary purpose of <code>ok</code> is to test your implementations.</p>

<!-- <p>First, some of the test cases are <i>locked</i>. To unlock tests, run the
following command from your terminal:</p>

<pre><code>python3 ok -u</code></pre>

<p>This command will start an interactive prompt that looks like:</p>

<pre>
=====================================================================
Assignment: Scheme Interpreter
Ok, version ...
=====================================================================

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Unlocking tests

At each "? ", type what you would expect the output to be.
Type exit() to quit

---------------------------------------------------------------------
Question 0 &gt; Suite 1 &gt; Case 1
(cases remaining: 1)

&gt;&gt;&gt; Code here
?
</pre>

<p>At the <code>?</code>, you can type what you expect the output to be. If you
are correct, then this test case will be available the next time you run the
autograder.</p>

<p>The idea is to understand <i>conceptually</i> what your program should do
first, before you start writing any code.</p>

<p>Once you have unlocked some tests and written some code, you can check the
correctness of your program using the tests that you have unlocked:</p>

<pre>python3 ok</pre>

<p>Most of the time, you will want to focus on a particular question. Use the
<code>-q</code> option as directed in the problems below.</p>  -->

<!-- <p>Second, there may be some test cases that are <i>hidden</i>. These test cases are
<b>not</b> run by the command:</p> -->

<!--<pre>python3 ok</pre>-->

<!-- <p>They are only run when you submit:</p> -->

<!-- <pre>python3 ok --submit</pre> -->

<!-- <p> We keep test cases hidden to ensure that you write your code with the intention
of solving the question at hand, not purely to pass the given tests. The hidden
tests will be run when you submit your project. You will receive an email with part of
the autograder results after submitting. However, the autograder has a 15 minute
cooldown period. If you submit before 15 minutes have passed, the autograder will
not run.</p> -->

<!-- <p>We recommend that you submit <b>after you finish each
problem</b>. Only your last submission will be graded. It is also useful for us
to have more backups of your code in case you run into a submission issue. <b>If you forget to submit, your last backup will be automatically converted to a submission. </b></p>
-->

<!--<p>After you run this command, you will receive an email (to the address-->
<!--that you used to sign up for Ok) that has the output from all <i>failed</i>-->
<!--unlocked tests, including hidden tests, along with your score at the bottom. You-->
<!--can continue submitting until you pass all the tests. However, you will receive-->
<!--<b>at most one email every half hour</b>.</p>-->

<!--<p>This buffer period is meant for you and your partner to try and understand-->
<!--where your error comes from, and take some time to think through your code. We-->
<!--encourage you to do this for all projects.</p>-->

<!---
<p>If you are trying to debug a test failure, you can launch an interactive session
after the test is run with:</p>

<pre><code>python3 ok &#x2d;q 05 &#x2d;i</code></pre>

<p>This will run the tests and launch an interactive session if a test does not
pass.</p>

<pre><code>=====================================================================
Assignment: Project 1: Hog
Ok, version ....
=====================================================================

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Running tests

&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;&#x2d;
Question ... &gt; Suite ... &gt; Case ...

&gt;&gt;&gt; the_test()
"expected value"

# Error: expected
#     "expected value"
# but got
#     None

# Interactive console. Type exit() to quit
&gt;&gt;&gt;</code></pre>
-->


<!--- <p>The <code>tests</code> folder is used to store autograder tests, so
<b>do not modify it</b>. You may lose all your unlocking progress if you
do. If you need to get a fresh copy, you can download the
<a href="scheme.zip">zip archive</a> and copy it over, but you
will need to start unlocking from scratch.</p> -->

<!---
<p>If you do not want us to record a backup of your work or information about
your progress, you can run

<pre>python3 ok --local</pre>


With this option, no information will be sent to our course
servers.

-->

<p>If you want to test your code interactively, you can run

<pre> python3 ok -q [question number] -i </pre>

with the appropriate question number (e.g. <code>01</code>) inserted.
This will run the tests for that question until the first one you failed,
then give you a chance to test the functions you wrote interactively.</p>

<p>You can also use the debugging print feature in OK by writing

<pre> print("DEBUG:", x) </pre>

which will produce an output in your terminal without causing OK tests to fail
with extra output.

<h2 id="interpreter-details">Interpreter details</h2>



<h3 id="scheme-features">Scheme features</h3>


<p><strong>Read-Eval-Print.</strong> The interpreter reads Scheme expressions, evaluates them,
and displays the results.</p>

<pre><code class="scheme">scm&gt; 2
2
scm&gt; (+ 2 3)
5
scm&gt; ((lambda (x) (* x x)) 5)
25</code></pre>



<p>The starter code provided for the Scheme interpreter is enough to successfully
evaluate the first expression above, since it consists of a single number. However,
more complicated operations such as the second example (a call to a built-in procedure)
and the third (a computation of 5 squared) will not work <em>just yet</em>.</p>

<p><strong>Load.</strong> You can load a file by passing in a symbol for the file name.
For example, to load <code>tests.scm</code>, evaluate the following call expression.</p>

<pre><code class="scheme">scm&gt; (load &#x27;tests)</code></pre>



<p><strong>Symbols.</strong> In the dialect of Scheme we use in CS 61A, a symbol (or
<em>identifier</em>) is a sequence of letters (a-z and A-Z), digits, and characters in
<code>!$%&amp;*/:&lt;=&gt;?@^_~&#x2d;+.</code> that do not form a valid integer or floating-point numeral.</p>

<p>Our version of Scheme is case-insensitive: two identifiers are considered
identical if they differ only in the capitalization of letters.
They are internally represented and printed in lower case:</p>

<pre><code class="scheme">scm&gt; &#x27;Hello
hello</code></pre>



<!-- **Turtle Graphics.** In addition to standard Scheme procedures, we include -->
<!-- procedure calls to the Python <code>turtle</code> package. This will come in handy -->
<!-- for the contest. -->

<!-- If you're curious, you can read the <a href="http://docs.python.org/py3k/library/turtle.html">turtle module -->
<!-- documentation</a> online. -->


<h3 id="running-the-interpreter">Running the interpreter</h3>


<p>To start an interactive Scheme interpreter session, type:</p>

<pre><code>python3 scheme.py</code></pre>

<p>To exit the Scheme interpreter, press <code>Ctrl&#x2d;d</code> on Mac/Linux (or <code>Ctrl&#x2d;z Enter</code> on Windows) or evaluate the built-in <code>exit</code> procedure
(after completing problems 3 and 4, where calling built-in Scheme procedures is implemented):</p>

<pre><code class="scheme">scm&gt; (exit)</code></pre>



<p>You can use your Scheme interpreter to evaluate the expressions in an input file
by passing the file name as a command-line argument to <code>scheme.py</code>:</p>

<pre><code>python3 scheme.py tests.scm</code></pre>

<p>The <code>tests.scm</code> file contains a long list of sample Scheme expressions and
their expected values. Many of these examples are from Chapters 1 and 2 of
<a href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/index.html">Structure and Interpretation of Computer Programs</a>, the textbook from
which Composing Programs is adapted.</p>

<br>


<h2 id="getting-started-videos">Getting Started Videos</h2>


<p>These videos may provide some helpful direction for tackling the coding
problems on this assignment.</p>

<blockquote><p>To see these videos, you should be logged into your berkeley.edu email.</p></blockquote>


            <iframe width="560" height="315" src="https://youtube.com/embed/videoseries?list=PLx38hZJ5RLZdd1fUp1X2OWs9WgbwvXl4V"
                frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe><p><a href='https://youtu.be/playlist?list=PLx38hZJ5RLZdd1fUp1X2OWs9WgbwvXl4V'> YouTube link </a></p>


<h2 id="part-1-the-evaluator">Part 1: The Evaluator</h2>


<p>In the starter implementation given to you, the interpreter can only evaluate
self-evaluating expressions: numbers, booleans, and <code>nil</code>.</p>

<p>In Part 1, you will develop the following features of the interpreter:</p>

<ul>
  <li>Symbol definition and lookup</li>
  <li>Expression evaluation</li>
  <li>Calling built-in procedures (such as <code>+</code>, <code>exit</code>, <code>equal?</code>, etc.; see the <a href="../scheme.html">built-in procedure reference</a> for the full list)</li>
</ul>

<p>First, let's understand some relevant functions and classes.</p>

<p>Take a look at two important functions, <code>scheme_eval</code> and <code>scheme_apply</code>, in the "Eval/Apply" section of
<code>scheme_eval_apply.py</code>:</p>

<ul>
  <li><code>scheme_eval</code> evaluates a Scheme expression <code>expr</code> in the given environment <code>env</code>. This
  function is nearly complete but is missing the logic for call expressions.</li>
  <li>Consider this <code>if</code>-statement block in <code>scheme_eval</code>:</li>
</ul>

<pre><code>  if scheme_symbolp(first) and first in scheme_forms.SPECIAL_FORMS:
      return scheme_forms.SPECIAL_FORMS[first](rest, env)</code></pre>



<p>Notice that when evaluating a special form, <code>scheme_eval</code> redirects evaluation to an
  appropriate <code>do_?_form</code> function found in <code>scheme_forms.py</code>. Some examples of special forms
  are <code>and</code>, <code>or</code>, <code>cond</code>, <code>if</code> (note that these are <em>not</em> Built-In Procedures). We will work on
  implementing <code>do_?_form</code> functions in a future part.</p>

<ul>
  <li><code>scheme_apply</code> <em>applies</em> a procedure to some arguments.</li>
</ul>

<p>Now, take a look at the "Environments" and "Procedures" sections of <code>scheme_classes.py</code>:</p>

<ul>
  <li>The <code>Frame</code> class represents an environment frame, much like the ones we work with in environment diagrams.</li>
  <li>The <code>LambdaProcedure</code> class (in the "Procedures" section) represents
  user-defined procedures.</li>
</ul>

<blockquote><p><strong>IMPORTANT NOTE:</strong> Since all non-atomic Scheme expressions (i.e., call expressions, special forms, definitions) are Scheme lists (and therefore linked lists), we use the <code>Pair</code> class to represent them. The <code>Pair</code> class is similar to the <code>Link</code> class we've been working with. For example, the expression <code>(+ 1 2)</code> will be represented in our interpreter as <code>Pair(&#x27;+&#x27;, Pair(1, Pair(2, nil)))</code>. More complicated expressions can be represented with nested <code>Pair</code>s. For example, the expression<code>(+ 1 (* 2 3))</code> will be represented as <code>Pair(&#x27;+&#x27;, Pair(1, Pair(Pair(&#x27;*&#x27;, Pair(2, Pair(3, nil))), nil)))</code>.
<strong>The <code>Pair</code> class is defined in <code>pair.py</code>.</strong> Please take a look at this class before starting the project! Notice the similarities with the <code>Link</code> class.</p></blockquote>

<p>Use Ok to test your understanding:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q eval_apply -u<button id="copy-code-python3ok-qeval_apply-u" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-qeval_apply-u").onclick = () => copyCode('python3 ok -q eval_apply -u', "copy-code-python3ok-qeval_apply-u");
        </script>
        <br/>


<h3 id="problem-1-1-pt">Problem 1 (1 pt)</h3>


<p>Implement the <code>define</code> and <code>lookup</code> methods of the <code>Frame</code> class in <code>scheme_classes.py</code>.</p>

<p>Each <code>Frame</code> object has the following instance attributes:</p>

<ul>
  <li><code>bindings</code> is a dictionary representing the bindings in the frame instance. Each item
  associates a Scheme symbol (represented as a Python string) to a Scheme value.</li>
  <li><code>parent</code> is the parent <code>Frame</code> instance (parent environment frame). The parent of the Global Frame is
  <code>None</code>.</li>
</ul>

<p>To complete these methods:</p>

<ol>
  <li><code>define</code> takes a symbol (represented by a Python string) and a value. It
  binds the symbol to the value in the <code>Frame</code> instance using <code>bindings</code>.</li>
  <li><p><code>lookup</code> takes a symbol and returns the value bound to that symbol in the
  first frame of the environment where it is found. The
  <em>environment</em> for a <code>Frame</code> instance consists of that frame, its parent
  frame, and all its ancestor frames, including the Global Frame. When looking
  up a symbol:</p>

  <ul>
    <li>If the symbol is bound in the current frame, return its value.</li>
    <li>If the symbol is not bound in the current frame and the frame has a parent
    frame, look up the symbol in the parent frame.</li>
    <li>If the symbol is not found in the current frame and there is no parent frame,
    raise a <code>SchemeError</code>.</li>
  </ul></li>
</ol>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 01 -u
python3 ok -q 01<button id="copy-code-python3ok-q01-upython3ok-q01" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q01-upython3ok-q01").onclick = () => copyCode('python3 ok -q 01 -u\npython3 ok -q 01', "copy-code-python3ok-q01-upython3ok-q01");
        </script>
        <br/>


        <button id='toggle-1' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q1 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-1">
  <prompt>

<pre><code>&gt;&gt;&gt; global_frame = create_global_frame()
&gt;&gt;&gt; global_frame.define(&quot;x&quot;, 3)
&gt;&gt;&gt; global_frame.parent is None
______
&gt;&gt;&gt; global_frame.lookup(&quot;x&quot;)
______
&gt;&gt;&gt; global_frame.define(&quot;x&quot;, 2)
&gt;&gt;&gt; global_frame.lookup(&quot;x&quot;)
______
&gt;&gt;&gt; global_frame.lookup(&quot;foo&quot;)
Choose the number of the correct choice:
  0) SchemeError
  1) 3
  2) None
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>&gt;&gt;&gt; first_frame = create_global_frame()
&gt;&gt;&gt; first_frame.define(&quot;x&quot;, 3)
&gt;&gt;&gt; second_frame = Frame(first_frame)
&gt;&gt;&gt; second_frame.parent == first_frame
______
&gt;&gt;&gt; second_frame.define(&quot;y&quot;, False)
&gt;&gt;&gt; second_frame.lookup(&quot;x&quot;)
______
&gt;&gt;&gt; second_frame.lookup(&quot;y&quot;)
______</code></pre>

<p></prompt>
</div></p>

<p>After you complete this problem, you can start your slightly improved Scheme interpreter
(with <code>python3 scheme.py</code>). You should now be able to look up built-in
procedure names:</p>

<pre><code class="scheme">scm&gt; +
#[+]
scm&gt; odd?
#[odd?]</code></pre>



<p>However, your Scheme interpreter will still not be able to <em>call</em> these
procedures until you complete the next problem.</p>

<p>Remember, at this point, you can only exit the interpreter by pressing <code>Ctrl&#x2d;d</code> on Max/Linux (or <code>Ctrl&#x2d;z Enter</code> on Windows).</p>


<h3 id="problem-2-2-pt">Problem 2 (2 pt)</h3>


<p>To be able to call built-in procedures, such as <code>+</code>, you need to complete the
<code>BuiltinProcedure</code> case within the <code>scheme_apply</code> function in
<code>scheme_eval_apply.py</code>. Built-in procedures are applied by calling a
corresponding Python function that implements the procedure.</p>

<blockquote><p>To see a list of all Scheme built-in procedures used in the project, look in
the <code>scheme_builtins.py</code> file. Any function decorated with <code>@builtin</code>
will be added to the globally-defined <code>BUILTINS</code> list.</p></blockquote>

<p>A <code>BuiltinProcedure</code> has two instance attributes:</p>

<ul>
  <li><code>py_func</code>: the <em>Python</em> function that implements the built-in Scheme procedure.</li>
  <li><code>need_env</code>: a Boolean that indicates whether or not this built-in
  procedure will need the current environment to be passed in as the last
  argument. The environment is required, for instance, to implement the built-in
  <code>eval</code> procedure.</li>
</ul>

<p><code>scheme_apply</code> takes the <code>procedure</code> object, a list of argument values <code>args</code>, and
the current environment <code>env</code>.
<code>args</code> is a Scheme list, represented as a <code>Pair</code> object or <code>nil</code>,
containing the values passed to the <code>procedure</code>. For example, if the Scheme Built-In Procedure we
are trying to use is <code>+</code> and we pass in <code>args</code> as <code>Pair(1, Pair(2, nil))</code> to <code>scheme_apply</code>,
we would be making the call <code>(+ 1 2)</code>.</p>

<blockquote><p>Your implementation should do the following:</p>

<ul>
  <li>Convert the Scheme list to a Python list of arguments. <em>Hint:</em> <code>args</code> is a
  <code>Pair</code>, which has <code>.first</code> and <code>.rest</code> attributes.</li>
  <li>If <code>procedure.need_env</code> is <code>True</code>, then add the current environment <code>env</code>
  as the last argument to this Python list.</li>
  <li>Return the result of calling <code>procedure.py_func</code> on all of those arguments. Since you don't know the exact number of arguments, use <code>*args</code> notation: <code>f(1, 2, 3)</code> is equivalent to <code>f(*[1, 2, 3]</code>). Do this part within the <code>try</code> statement provided, after the line that says <code>try:</code>.</li>
</ul></blockquote>

<p>We have already implemented the following behavior for you:</p>

<ul>
  <li>If calling the function results in a <code>TypeError</code> exception being raised, then
  the wrong number of arguments were passed. The <code>try</code> statement
  handles this exception and raises a <code>SchemeError</code> with the message
  <code>&#x27;incorrect number of arguments&#x27;</code>.</li>
</ul>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 02 -u
python3 ok -q 02<button id="copy-code-python3ok-q02-upython3ok-q02" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q02-upython3ok-q02").onclick = () => copyCode('python3 ok -q 02 -u\npython3 ok -q 02', "copy-code-python3ok-q02-upython3ok-q02");
        </script>
        <br/>


        <button id='toggle-2' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q2 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-2">
  <prompt>

<pre><code>&gt;&gt;&gt; env = create_global_frame()
&gt;&gt;&gt; twos = Pair(2, Pair(2, nil))
&gt;&gt;&gt; plus = BuiltinProcedure(scheme_add) # + procedure
&gt;&gt;&gt; scheme_apply(plus, twos, env) # Type SchemeError if you think this errors
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>&gt;&gt;&gt; env = create_global_frame()
&gt;&gt;&gt; plus = BuiltinProcedure(scheme_add) # + procedure
&gt;&gt;&gt; scheme_apply(plus, nil, env) # Remember what (+) evaluates to in scheme
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>&gt;&gt;&gt; env = create_global_frame()
&gt;&gt;&gt; twos = Pair(2, Pair(2, nil))
&gt;&gt;&gt; oddp = BuiltinProcedure(scheme_oddp) # odd? procedure
&gt;&gt;&gt; scheme_apply(oddp, twos, env) # Type SchemeError if you think this errors
______</code></pre>

<p></prompt>
</div></p>

<p>üë©üèΩ‚Äçüíªüë®üèø‚Äçüíª <a href="../../articles/pair-programming.html">Pair programming?</a>
Remember to alternate between driver and navigator roles.
The driver controls the keyboard;
the navigator watches, asks questions, and suggests ideas.</p>


<h3 id="problem-3-2-pt">Problem 3 (2 pt)</h3>


<p>The <code>scheme_eval</code> function (in <code>scheme_eval_apply.py</code>) evaluates a Scheme
expression in an environment. The provided code
already looks up symbols in the current environment, returns self-evaluating
expressions (such as numbers), and evaluates special forms.</p>

<p>Implement the missing part of <code>scheme_eval</code>, which evaluates a call expression.
To evaluate a call expression:</p>

<ol>
  <li>Evaluate the operator (which should evaluate to a <code>Procedure</code> instance ‚Äì¬†see <code>scheme_classes.py</code> for <code>Procedure</code> definitions).</li>
  <li>Evaluate all of the operands and collect the results (the argument values) in a Scheme list.</li>
  <li>Return the result of calling <code>scheme_apply</code> on this <code>Procedure</code> and these argument values.</li>
</ol>

<p>You'll have to recursively call <code>scheme_eval</code> in the first two steps. Here are
some other functions/methods you should use:</p>

<ul>
  <li>The <code>map</code> method of <code>Pair</code> returns a new Scheme list constructed by applying a
  <em>one-argument function</em> to every item in a Scheme list. Think about what function we want to apply
  to every operand.</li>
  <li>The <code>scheme_apply</code> function applies a Scheme procedure to arguments
  represented as a Scheme list (a <code>Pair</code> instance or <code>nil</code>).</li>
</ul>

<blockquote><p><strong>Important</strong>: do not mutate the passed-in <code>expr</code>. That would change a program as
it's being evaluated, creating strange and incorrect effects.</p></blockquote>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 03 -u
python3 ok -q 03<button id="copy-code-python3ok-q03-upython3ok-q03" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q03-upython3ok-q03").onclick = () => copyCode('python3 ok -q 03 -u\npython3 ok -q 03', "copy-code-python3ok-q03-upython3ok-q03");
        </script>
        <br/>


        <button id='toggle-3' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q3 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-3">
  <prompt>

<pre><code>&gt;&gt;&gt; expr = read_line(&#x27;(+ 2 2)&#x27;)
&gt;&gt;&gt; scheme_eval(expr, create_global_frame()) # Type SchemeError if you think this errors
______
&gt;&gt;&gt; scheme_eval(Pair(&#x27;+&#x27;, Pair(2, Pair(2, nil))), create_global_frame()) # Type SchemeError if you think this errors
______
&gt;&gt;&gt; expr = read_line(&#x27;(+ (+ 2 2) (+ 1 3) (* 1 4))&#x27;)
&gt;&gt;&gt; scheme_eval(expr, create_global_frame()) # Type SchemeError if you think this errors
______
&gt;&gt;&gt; expr = read_line(&#x27;(yolo)&#x27;)
&gt;&gt;&gt; scheme_eval(expr, create_global_frame()) # Type SchemeError if you think this errors
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>scm&gt; (* (+ 3 2) (+ 1 7)) ; Type SchemeError if you think this errors
______
scm&gt; (1 2) ; Type SchemeError if you think this errors
______</code></pre>

<p></prompt>
</div></p>

<blockquote><p>Some of these tests call a primitive (built-in) procedure called
<code>print&#x2d;then&#x2d;return</code>. This procedure doesn't exist in Scheme, but was added to
this project just to test this question. <code>print&#x2d;then&#x2d;return</code> takes two
arguments. It prints out its first argument and returns the second. If you're interested, you can
find this function at the bottom of <code>scheme_builtins.py</code></p></blockquote>

<p>Your interpreter should now be able to evaluate built-in procedure calls, giving
you the functionality of the Calculator language and more. Run <code>python3
scheme.py</code>, and you can now add and multiply!</p>

<pre><code class="scheme">scm&gt; (+ 1 2)
3
scm&gt; (* 3 4 (&#x2d; 5 2) 1)
36
scm&gt; (odd? 31)
#t</code></pre>




<h3 id="problem-4-2-pt">Problem 4 (2 pt)</h3>


<p>The <code>define</code> special form (<a href="../../articles/scheme-spec/index.html#define">spec</a>) in Scheme can be used <em>either</em> to assign the value of a given expression
to a symbol or to create a procedure and bind it to a symbol:</p>

<pre><code class="scheme">scm&gt; (define a (+ 2 3))  ; Binds the symbol a to the value of expression (+ 2 3)
a
scm&gt; (define (foo x) x)  ; Creates a procedure and binds it to the symbol foo
foo</code></pre>



<p>Notice that the type of the first operand can tell us what is being defined:</p>

<ul>
  <li>If it is a symbol, e.g. <code>a</code>, then the expression is defining a symbol.</li>
  <li>If it is a Scheme list, e.g. <code>(foo x)</code>, then the expression is creating a procedure.</li>
</ul>

<p>The <code>do_define_form</code> function in <code>scheme_forms.py</code> evaluates <code>(define ...)</code>
expressions. There are two missing parts in this function; one for when the first
operand is a symbol, and the other for when it is a Scheme list (i.e. <code>Pair</code>).
For this problem, implement <strong>just the first part</strong>, which evaluates the second
operand to obtain a value and binds the first operand, a symbol, to that value. Then,
<code>do_define_form</code> returns the symbol that was bound.</p>

<blockquote><p><em>Hint:</em> The <code>define</code> method of a <code>Frame</code> instance creates a binding in that
frame.</p></blockquote>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 04 -u
python3 ok -q 04<button id="copy-code-python3ok-q04-upython3ok-q04" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q04-upython3ok-q04").onclick = () => copyCode('python3 ok -q 04 -u\npython3 ok -q 04', "copy-code-python3ok-q04-upython3ok-q04");
        </script>
        <br/>


        <button id='toggle-4' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q4 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-4">
  <prompt>

<pre><code>What is the structure of the expressions argument to do_define_form?

Choose the number of the correct choice:
  0) Pair(A, Pair(B, nil)), where:
        A is the symbol being bound,
        B is an expression whose value should be evaluated and bound to A
  1) Pair(A, Pair(B, nil)), where:
        A is the symbol being bound,
        B is the value that should be bound to A
  2) Pair(&#x27;define&#x27;, Pair(A, Pair(B, nil))), where:
        A is the symbol being bound,
        B is an expression whose value should be evaluated and bound to A
  3) Pair(A, Pair(B, nil)), where:
        A is the symbol being bound,
        B is an expression whose value should be evaluated and bound to A
  4) Pair(A, B), where:
        A is the symbol being bound,
        B is an expression whose value should be evaluated and bound to A

______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>What method of a Frame instance will binda value to a symbol in that frame?

Choose the number of the correct choice:
  0) lookup
  1) define
  2) make_child_frame
  3) bindings

______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>scm&gt; (define size 2)
______
scm&gt; size
______
scm&gt; (define x (+ 7 3))
______
scm&gt; x
______</code></pre>

<p></prompt>
</div></p>

<p>You should now be able to assign values to symbols and evaluate those symbols.</p>

<pre><code class="scheme">scm&gt; (define x 15)
x
scm&gt; (define y (* 2 x))
y
scm&gt; y
30</code></pre>



<p>The following <code>ok</code> test determines whether the operator of a call expression is
evaluated multiple times. The operator should be evaluated only a <em>single</em> time
before raising an error (because <code>x</code> is not bound to a procedure).</p>

<pre><code class="scheme">(define x 0)
; expect x
((define x (+ x 1)) 2)
; expect SchemeError
x
; expect 1</code></pre>



<p>If the operator is evaluated twice, then <code>x</code> will be bound to 2 instead of 1 at
the end, causing the test to fail. Therefore, if your code fails this test,
you'll want to make sure you only evaluate the operator of a call expression
once in <code>scheme_eval</code>.</p>


<h3 id="problem-5-1-pt">Problem 5 (1 pt)</h3>


<p>In Scheme, you can quote expressions in two ways: with the <code>quote</code> special form
(<a href="../../articles/scheme-spec/index.html#quote">spec</a>) or with the symbol <code>&#x27;</code>.  The reader converts <code>&#x27;...</code> into
<code>(quote ...)</code>, so that your interpreter only needs to evaluate the <code>(quote ...)</code>
syntax. The <code>quote</code> special form returns its operand expression without
evaluating it:</p>

<pre><code class="scheme">scm&gt; (quote hello)
hello
scm&gt; &#x27;(cons 1 2)  ; Equivalent to (quote (cons 1 2))
(cons 1 2)</code></pre>



<p>Implement the <code>do_quote_form</code> function in <code>scheme_forms.py</code> so that it simply
returns the unevaluated operand of the <code>(quote ...)</code> expression. <strong>Hint</strong>: Do not overthink this.
<!-- Where is the operand in any Scheme expression? --></p>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 05 -u
python3 ok -q 05<button id="copy-code-python3ok-q05-upython3ok-q05" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q05-upython3ok-q05").onclick = () => copyCode('python3 ok -q 05 -u\npython3 ok -q 05', "copy-code-python3ok-q05-upython3ok-q05");
        </script>
        <br/>


        <button id='toggle-5' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q5 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-5">
  <prompt>

<pre><code>What is the structure of the expressions argument to do_quote_form?

Choose the number of the correct choice:
  0) A, where:
        A is the quoted expression
  1) Pair(A, nil), where:
        A is the quoted expression
  2) [A], where:
        A is the quoted expression
  3) Pair(&#x27;quote&#x27;, Pair(A, nil)), where:
        A is the quoted expression

______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>&gt;&gt;&gt; global_frame = create_global_frame()
&gt;&gt;&gt; do_quote_form(Pair(3, nil), global_frame)
______
&gt;&gt;&gt; do_quote_form(Pair(&#x27;hi&#x27;, nil), global_frame)
______
&gt;&gt;&gt; expr = Pair(Pair(&#x27;+&#x27;, Pair(&#x27;x&#x27;, Pair(2, nil))), nil)
&gt;&gt;&gt; do_quote_form(expr, global_frame) # Make sure to use Pair notation
______</code></pre>

<p></prompt>
</div></p>

<p>After completing this function, you should be able to evaluate quoted
expressions. Try out some of the following in your interpreter!</p>

<pre><code class="scheme">scm&gt; (quote a)
a
scm&gt; (quote (1 2))
(1 2)
scm&gt; (quote (1 (2 three (4 5))))
(1 (2 three (4 5)))
scm&gt; (car (quote (a b)))
a
scm&gt; &#x27;hello
hello
scm&gt; &#x27;(1 2)
(1 2)
scm&gt; &#x27;(1 (2 three (4 5)))
(1 (2 three (4 5)))
scm&gt; (car &#x27;(a b))
a
scm&gt; (eval (cons &#x27;car &#x27;(&#x27;(1 2))))
1
scm&gt; (eval (define tau 6.28))
6.28
scm&gt; (eval &#x27;tau)
6.28
scm&gt; tau
6.28</code></pre>



<!-- **Submit your Phase 1 checkpoint** -->

<p>Check to make sure that you completed all the problems in Phase 1:</p>

<pre><code>python3 ok &#x2d;&#x2d;score</code></pre>

<!-- Then, submit <code>scheme_eval_apply.py</code>, <code>scheme_forms.py</code>, <code>scheme_classes.py</code>, and <code>questions.scm</code> to the **Scheme Checkpoint 1** assignment on **Gradescope** before the first checkpoint deadline.

When you run <code>ok</code> commands, you'll still see that some tests are locked
because you haven't completed the whole project yet. You'll get full credit for
the checkpoint if you complete all the problems up to this point. -->


<h2 id="part-2-procedures">Part 2: Procedures</h2>


<p>In Part 2, you will add the ability to create and call user-defined procedures.
You will add the following features to the interpreter:</p>

<ul>
  <li>Lambda procedures, using the <code>(lambda ...)</code> special form</li>
  <li>Named procedures, using the <code>(define (...) ...)</code> special form</li>
  <li>Dynamically scoped mu procedures, using the <code>(mu ...)</code> special form.</li>
</ul>


<h3 id="problem-6-1-pt">Problem 6 (1 pt)</h3>


<p>Change the <code>eval_all</code> function in <code>scheme_eval_apply.py</code> (which is called from
<code>do_begin_form</code> in <code>scheme_forms.py</code>) to complete the implementation of the
<code>begin</code> special form (<a href="../../articles/scheme-spec/index.html#begin">spec</a>).</p>

<p>A <code>begin</code> expression is evaluated by evaluating all sub-expressions in order.
The value of the <code>begin</code> expression is the value of the final sub-expression.</p>

<p>To complete the implementation of <code>begin</code>, <code>eval_all</code> will take in <code>expressions</code>
(a Scheme list of expressions) and <code>env</code> (a <code>Frame</code> representing the current
environment), evaluate all the expressions in <code>expressions</code>, and return the
value of the last expression in <code>expressions</code>.</p>

<pre><code class="scheme">scm&gt; (begin (+ 2 3) (+ 5 6))
11
scm&gt; (define x (begin (display 3) (newline) (+ 2 3)))
3
x
scm&gt; (+ x 3)
8
scm&gt; (begin (print 3) &#x27;(+ 2 3))
3
(+ 2 3)</code></pre>



<p>If <code>eval_all</code> is passed an empty list of expressions (<code>nil</code>), then it should
return the Python value <code>None</code>, which represents the Scheme value <code>undefined</code>.</p>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 06 -u
python3 ok -q 06<button id="copy-code-python3ok-q06-upython3ok-q06" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q06-upython3ok-q06").onclick = () => copyCode('python3 ok -q 06 -u\npython3 ok -q 06', "copy-code-python3ok-q06-upython3ok-q06");
        </script>
        <br/>


        <button id='toggle-6' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q6 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-6">
  <prompt>

<pre><code>&gt;&gt;&gt; env = create_global_frame()
&gt;&gt;&gt; eval_all(Pair(2, nil), env)
Choose the number of the correct choice:
  0) 2
  1) SchemeError
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>&gt;&gt;&gt; eval_all(Pair(4, Pair(5, nil)), env)
Choose the number of the correct choice:
  0) (4 5)
  1) 5
  2) 4
  3) SchemeError
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>scm&gt; (begin (+ 2 3) (+ 5 6))
______
scm&gt; (begin (define x 3) x)
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>scm&gt; (begin 30 &#x27;(+ 2 2))
Choose the number of the correct choice:
  0) 30
  1) 4
  2) &#x27;(+ 2 2)
  3) (+ 2 2)
______
scm&gt; (define x 0)
______
scm&gt; (begin (define x (+ x 1)) 42 (define y (+ x 1)))
______
scm&gt; x
______
scm&gt; y
______</code></pre>

<p></prompt>
</div></p>

<p>üë©üèΩ‚Äçüíªüë®üèø‚Äçüíª <a href="../../articles/pair-programming.html">Pair programming?</a>
This would be a good time to switch roles.
Switching roles makes sure
that you both benefit from the learning experience of being in each role.</p>


<h3 id="user-defined-procedures">User-Defined Procedures</h3>


<p>User-defined lambda procedures are represented as instances of the <code>LambdaProcedure</code>
class. A <code>LambdaProcedure</code> instance has three instance attributes:</p>

<ul>
  <li><code>formals</code>: a Scheme list containing the formal parameter names for the arguments of the lambda procedure.</li>
  <li><code>body</code>: a nested Scheme list of expressions representing the body of the procedure.</li>
  <li><code>env</code>: the environment in which the procedure was <strong>defined</strong>.</li>
</ul>

<p>For example, in <code>(lambda (x y) (+ x y))</code>, <code>formals</code> is <code>Pair(&#x27;x&#x27;, Pair(&#x27;y&#x27;, nil))</code>.
<code>body</code> is <code>Pair(Pair(&#x27;+&#x27;, Pair(&#x27;x&#x27;, Pair(&#x27;y&#x27;, nil))), nil)</code>, which is a nested Scheme list where the
first element (<code>body.first</code>) is the expression <code>(+ x y)</code> represented as <code>Pair(&#x27;+&#x27;, Pair(&#x27;x&#x27;, Pair(&#x27;y&#x27;, nil)))</code>. <code>body</code> is nested
to allow for complex expressions and nested function calls.</p>


<h3 id="problem-7-2-pt">Problem 7 (2 pt)</h3>


<p>Implement the <code>do_lambda_form</code> function (<a href="../../articles/scheme-spec/index.html#lambda">spec</a>) in
<code>scheme_forms.py</code>, which creates and returns a <code>LambdaProcedure</code> instance.</p>

<p>In Scheme, the body of a procedure can contain multiple expressions, but must include at least one.
The <code>body</code> attribute of a <code>LambdaProcedure</code> instance is a nested Scheme list of these expressions,
and the <code>formals</code> attribute is a properly nested <code>Pair</code> expression (see <strong>User-Defined Procedures</strong> for an example).
Like a <code>begin</code> special form, evaluating the body of a procedure executes all expressions in order,
<em>with the return value being the result of the last expression</em>.</p>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 07 -u
python3 ok -q 07<button id="copy-code-python3ok-q07-upython3ok-q07" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q07-upython3ok-q07").onclick = () => copyCode('python3 ok -q 07 -u\npython3 ok -q 07', "copy-code-python3ok-q07-upython3ok-q07");
        </script>
        <br/>


        <button id='toggle-7' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q7 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-7">
  <prompt>

<pre><code>scm&gt; (lambda (x y) (+ x y)) ;; An lambda procedure is displayed exactly as it is written
______
scm&gt; (lambda (x)) ; type SchemeError if you think this causes an error
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>&gt;&gt;&gt; env = create_global_frame()
&gt;&gt;&gt; lambda_line = read_line(&quot;(lambda (a b c) (+ a b c))&quot;)
&gt;&gt;&gt; lambda_proc = do_lambda_form(lambda_line.rest, env)
&gt;&gt;&gt; lambda_proc.formals # use single quotes &#x27; around strings in your answer
Choose the number of the correct choice:
  0) Pair(&#x27;a&#x27;, Pair(&#x27;b&#x27;, Pair(&#x27;c&#x27;, nil)))
  1) Pair(&#x27;+&#x27;, Pair(&#x27;a&#x27;, Pair(&#x27;b&#x27;, Pair(&#x27;c&#x27;, nil))))
  2) Pair(Pair(&#x27;a&#x27;, Pair(&#x27;b&#x27;, Pair(&#x27;c&#x27;, nil))))
______
&gt;&gt;&gt; lambda_proc.body # the body is a *Scheme list* of expressions! Make sure your answer is a properly nested Pair.
Choose the number of the correct choice:
  0) Pair(&#x27;+&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;)
  1) Pair(&#x27;a&#x27;, Pair(&#x27;b&#x27;, Pair(&#x27;c&#x27;)))
  2) Pair(Pair(&#x27;+&#x27;, Pair(&#x27;a&#x27;, Pair(&#x27;b&#x27;, Pair(&#x27;c&#x27;, nil)))), nil)
  3) Pair(&#x27;+&#x27;, Pair(&#x27;a&#x27;, Pair(&#x27;b&#x27;, Pair(&#x27;c&#x27;, nil))))
______</code></pre>

<p></prompt>
</div></p>

<p>While you cannot call a user-defined procedure yet, you can visually verify that you
have created the procedure correctly by evaluating a lambda expression in your interpreter.</p>

<pre><code class="scheme">scm&gt; (lambda (x y) (+ x y))
(lambda (x y) (+ x y))</code></pre>




<h3 id="problem-8-2-pt">Problem 8 (2 pt)</h3>


<!-- 
        <button id='toggle-8' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Hint Video<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-8">


            <iframe width="560" height="315" src="https://youtube.com/embed/gLPMuGZK0Jc"
                frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe><p><a href='https://youtu.be/gLPMuGZK0Jc'> YouTube link </a></p>

</div> -->

<p>Implement the <code>make_child_frame</code> method of the <code>Frame</code> class
(in <code>scheme_classes.py</code>), which will be used to create new frames when calling
user-defined procedures. This method takes in two arguments: <code>formals</code>, which is
a Scheme list of symbols (ex: <code>Pair(&#x27;x&#x27;, Pair(&#x27;y&#x27;, nil))</code>), and <code>vals</code>, which is a
Scheme list of values (ex: <code>Pair(3, Pair(5, nil))</code>). It should return a new child frame
with the formal parameters bound to the values.</p>

<p>To do this:</p>

<ul>
  <li>If the number of argument values does not match with the number of formal parameters, raise a <code>SchemeError</code>.</li>
  <li>Create a new <code>Frame</code> instance, the parent of which is <code>self</code>.</li>
  <li>Bind each formal parameter to its corresponding value in the newly
  created frame. The first symbol in <code>formals</code> should be bound to the first
  value in <code>vals</code>, and so on. Remember that <code>formals</code> and <code>vals</code> are <code>Pair</code>s.</li>
  <li>Return the new frame.</li>
</ul>

<blockquote><p><em>Hint:</em> The <code>define</code> method of a <code>Frame</code> instance creates a binding in that
frame.</p></blockquote>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 08 -u
python3 ok -q 08<button id="copy-code-python3ok-q08-upython3ok-q08" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q08-upython3ok-q08").onclick = () => copyCode('python3 ok -q 08 -u\npython3 ok -q 08', "copy-code-python3ok-q08-upython3ok-q08");
        </script>
        <br/>


        <button id='toggle-9' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q8 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-9">
  <prompt>

<pre><code>&gt;&gt;&gt; global_frame = create_global_frame()
&gt;&gt;&gt; formals = Pair(&#x27;a&#x27;, Pair(&#x27;b&#x27;, Pair(&#x27;c&#x27;, nil)))
&gt;&gt;&gt; vals = Pair(1, Pair(2, Pair(3, nil)))
&gt;&gt;&gt; frame = global_frame.make_child_frame(formals, vals)
&gt;&gt;&gt; global_frame.lookup(&#x27;a&#x27;) # Type SchemeError if you think this errors
______
&gt;&gt;&gt; frame.lookup(&#x27;a&#x27;)        # Type SchemeError if you think this errors
______
&gt;&gt;&gt; frame.lookup(&#x27;b&#x27;)        # Type SchemeError if you think this errors
______
&gt;&gt;&gt; frame.lookup(&#x27;c&#x27;)        # Type SchemeError if you think this errors
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>&gt;&gt;&gt; global_frame = create_global_frame()
&gt;&gt;&gt; frame = global_frame.make_child_frame(nil, nil)
&gt;&gt;&gt; frame.parent is global_frame
______</code></pre>

<p></prompt>
</div></p>


<h3 id="problem-9-2-pt">Problem 9 (2 pt)</h3>

<!-- 
        <button id='toggle-10' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Hint Video<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-10">

            <iframe width="560" height="315" src="https://youtube.com/embed/QD0-Lw-8VDg"
                frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe><p><a href='https://youtu.be/QD0-Lw-8VDg'> YouTube link </a></p>

</div> -->

<p>Implement the <code>LambdaProcedure</code> case in the <code>scheme_apply</code> function
in <code>scheme_eval_apply.py</code>. Notice that this <code>elif</code> block is executed when the
procedure being applied is a <code>LambdaProcedure</code> instance.</p>

<p>First create a new <code>Frame</code> instance and bind the <code>procedure</code>'s formal parameters to
the argument values by calling the <code>make_child_frame</code> method on the appropriate parent frame.</p>

<p>Then, within this new frame, evaluate each of the expressions of the body of the procedure
using <code>eval_all</code>.</p>

<blockquote><p><em>Hint:</em> Your new frame should be a child of the frame in which the lambda is defined.
Note that the <code>env</code> provided as an argument to <code>scheme_apply</code> is instead the
frame in which the procedure is <em>called</em>.</p>

<p><em>Hint:</em> In <code>scheme_apply</code>, what variable represents the arguments being passed into the
procedure? Refer to Problem 2 if you need a refresher.</p>

<p>See <a href="../scheme.html#user-defined-procedures">User-Defined Procedures</a> to remind yourself
of the attributes of <code>LambdaProcedure</code>.</p></blockquote>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 09 -u
python3 ok -q 09<button id="copy-code-python3ok-q09-upython3ok-q09" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q09-upython3ok-q09").onclick = () => copyCode('python3 ok -q 09 -u\npython3 ok -q 09', "copy-code-python3ok-q09-upython3ok-q09");
        </script>
        <br/>


        <button id='toggle-11' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q9 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-11">
  <prompt>

<pre><code>scm&gt; (define x 5)
______
scm&gt; (define outer (lambda (x)
....   (lambda () (print x))))
______
scm&gt; (define inner (outer 2))
______
scm&gt; (inner) ;; which x is accessed? which frame is the parent?
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>&gt;&gt;&gt; global_frame = create_global_frame()
&gt;&gt;&gt; frame = global_frame.make_child_frame(nil, nil)
&gt;&gt;&gt; frame.parent is global_frame
______</code></pre>

<p></prompt>
</div></p>


<h3 id="problem-10-2-pt">Problem 10 (2 pt)</h3>

<!-- 
        <button id='toggle-12' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Hint Video<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-12">


            <iframe width="560" height="315" src="https://youtube.com/embed/zkXY8kliOeQ"
                frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe><p><a href='https://youtu.be/zkXY8kliOeQ'> YouTube link </a></p>

</div> -->

<p>Currently, your Scheme interpreter is able to bind symbols to user-defined
procedures in the following manner:</p>

<pre><code class="scheme">scm&gt; (define f (lambda (x) (* x 2)))
f</code></pre>


<p>because binding a symbol to an expression was implemented in Problem 4, and user-defined
procedures was implemented in Problem 9.</p>

<p>However, we'd like to be able to use the <em>shorthand</em> form of defining named
procedures, which is what we've been doing in homeworks and labs:</p>

<pre><code class="scheme">scm&gt; (define (f x) (* x 2))
f</code></pre>



<p>Can you see the difference between the two?</p>

<p>Modify the <code>do_define_form</code> function in <code>scheme_forms.py</code> so that it correctly handles
<code>define (...) ...)</code> expressions (<a href="../../articles/scheme-spec/index.html#define">spec</a>).</p>

<p>Make sure that it can handle multi-expression bodies. For example,</p>

<pre><code class="scheme">scm&gt; (define (g y) (print y) (+ y 1))
g
scm&gt; (g 3)
3
4</code></pre>



<p>There are (at least) two ways to solve this problem. One is to construct an expression <code>(define _ (lambda ...))</code> and call <code>do_define_form</code> on it (omitting the <code>define</code>).  The second is to implement it directly:</p>

<ul>
  <li>Using the given variables <code>signature</code> and <code>expressions</code>, find the defined
  function's name (symbol), formals, and body.</li>
  <li>Create a <code>LambdaProcedure</code> instance using the formals and body. (You could call <code>do_lambda_form</code> to do this.)</li>
  <li>Bind the symbol to this new <code>LambdaProcedure</code> instance.</li>
  <li>Return the symbol that was bound.</li>
</ul>

<blockquote><p><em>Doctest Walkthrough</em>:
Consider the doctest <code>do_define_form(read_line(‚Äú((f x) (+ x 2))‚Äú), env)</code>. This is the Python call that will evaluate
<code>(define (f x) (+ x 8))</code> in Scheme. <code>read_line</code> is a utility function that takes in ‚Äú((f x) (+ x 2))‚Äù and returns its <code>Pair</code> representation.
Therefore, that <code>Pair</code> representation is passed into <code>do_define_form</code> as its <code>expressions</code> parameter.</p>

<p><em>Hint for Way 2</em>: How can we utilize the Scheme list representation of <code>((f x) (+ x 2))</code> (the structure for <code>(define (f x) (* x 2))</code>)
to have the same functionality as <code>(define f (lambda (x) (+ x 2)))</code>, which we know our Scheme interpreter (and thus our Python code) can already
handle?
Try writing out the Scheme list representation yourself and consider what components you would need to extract from it in order to be able to
replicate the functionality of <code>(define f (lambda (x) (+ x 2)))</code> in Python within <code>do_define_form</code>.</p></blockquote>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 10 -u
python3 ok -q 10<button id="copy-code-python3ok-q10-upython3ok-q10" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q10-upython3ok-q10").onclick = () => copyCode('python3 ok -q 10 -u\npython3 ok -q 10', "copy-code-python3ok-q10-upython3ok-q10");
        </script>
        <br/>


        <button id='toggle-13' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q10 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-13">
  <prompt>

<pre><code>scm&gt; (define (f x y) (+ x y))
______
scm&gt; f
Choose the number of the correct choice:
  0) (lambda (x y) (+ x y))
  1) (lambda (f x y) (+ x y))
  2) (define f (lambda (x y) (+ x y)))
  3) (f (x y) (+ x y))
______</code></pre>

<p></prompt>
</div></p>


<h3 id="problem-11-2-pt">Problem 11 (2 pt)</h3>

<!-- 
        <button id='toggle-14' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Hint Video<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-14">


            <iframe width="560" height="315" src="https://youtube.com/embed/Ku-sXx-6Cys"
                frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe><p><a href='https://youtu.be/Ku-sXx-6Cys'> YouTube link </a></p>

</div> -->

<p>All of the Scheme procedures we've seen so far use <strong>lexical scoping</strong>: the parent
of the new call frame is the environment in which the procedure was <em>defined</em>.
Another type of scoping, which is not standard in Scheme but appears in other
variants of Lisp, is called <strong>dynamic scoping</strong>: the parent of the new call frame
is the environment in which the call expression was <em>evaluated</em>. With dynamic
scoping, calling the same procedure with the same arguments from different parts
of your code can create different behavior (due to different parent frames).</p>

<p>The <code>mu</code> special form (<a href="../../articles/scheme-spec/index.html#mu">spec</a>; invented for this project) evaluates
to a dynamically scoped procedure.</p>

<pre><code class="scheme">scm&gt; (define f (mu () (* a b)))
f
scm&gt; (define g (lambda () (define a 4) (define b 5) (f)))
g
scm&gt; (g)
20</code></pre>



<p>Above, the procedure <code>f</code> does not have <code>a</code> or <code>b</code> as arguments; however, because
<code>f</code> gets called <strong>within</strong> the procedure <code>g</code>, it has access to the <code>a</code> and <code>b</code>
defined in <code>g</code>'s frame.</p>

<p>Your job:</p>

<ul>
  <li>Implement <code>do_mu_form</code> in <code>scheme_forms.py</code> to evaluate the <code>mu</code> special form.
  A <code>mu</code> expression  evaluates to a <code>MuProcedure</code>. The <code>MuProcedure</code> class
  (defined in <code>scheme_classes.py</code>) has been provided for you.</li>
  <li>In addition to implementing <code>do_mu_form</code>, complete the <code>MuProcedure</code> case
  within the <code>scheme_apply</code> function (in <code>scheme_eval_apply.py</code>) so that when a
  mu procedure is called, its body is evaluated in the correct environment. When
  a <code>MuProcedure</code> is called, the parent of the new call frame is the environment
  in which that call expression was <strong>evaluated</strong>. As a result, a <code>MuProcedure</code>
  does not need to store an environment as an instance attribute. Your code here should
  be VERY similar to what you did for question 9.</li>
</ul>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 11 -u
python3 ok -q 11<button id="copy-code-python3ok-q11-upython3ok-q11" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q11-upython3ok-q11").onclick = () => copyCode('python3 ok -q 11 -u\npython3 ok -q 11', "copy-code-python3ok-q11-upython3ok-q11");
        </script>
        <br/>


        <button id='toggle-15' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q11 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-15">
  <prompt>

<pre><code>scm&gt; (define y 1)
______
scm&gt; (define f (mu (x) (+ x y)))
______
scm&gt; (define g (lambda (x y) (f (+ x x))))
______
scm&gt; (g 3 7)
______</code></pre>

<p></prompt>
</div></p>

<p>At this point in the project, your Scheme interpreter should support the
following features:</p>

<ul>
  <li>Creating procedures using <code>lambda</code> and <code>mu</code> expressions,</li>
  <li>Defining named procedures using <code>define</code> expressions, and</li>
  <li>Calling user-defined procedures.</li>
</ul>


<h3 id="submit-your-phase-1-amp-2-checkpoint">Submit your Phase 1 &amp; 2 checkpoint</h3>


<p>Check to make sure that you completed all the problems in Phase 1 and 2:</p>

<pre><code>python3 ok &#x2d;&#x2d;score</code></pre>

<p>Then, submit <code>scheme_eval_apply.py</code>, <code>scheme_forms.py</code>, <code>scheme_classes.py</code>, and <code>questions.scm</code> to the <strong>Scheme Checkpoint</strong> assignment on <strong>Gradescope</strong> before the checkpoint deadline.</p>

<p>When you run <code>ok</code> commands, you'll still see that some tests are locked
because you haven't completed the whole project yet. You'll get full credit for
the checkpoint if you complete all the problems up to this point.</p>


<h2 id="part-3-special-forms">Part 3: Special Forms</h2>


<p>This section will be completed in <code>scheme_forms.py</code>.</p>

<p>Logical special forms include <code>if</code>, <code>and</code>, <code>or</code>, and <code>cond</code>. These expressions
are special because not all of their sub-expressions may be evaluated.</p>

<p>In Scheme, only <code>#f</code> is a false value. All other values
(including <code>0</code> and <code>nil</code>) are true values. You can test whether a value is a
true or false value using the provided Python functions <code>is_scheme_true</code> and
<code>is_scheme_false</code>, defined in <code>scheme_utils.py</code>.</p>

<blockquote><p>Scheme traditionally uses <code>#f</code> to indicate the false Boolean value. In our
interpreter, that is equivalent to <code>false</code> or <code>False</code>. Similarly, <code>true</code>,
<code>True</code>, and <code>#t</code> are all equivalent. However, <strong>when unlocking tests</strong>, use
<code>#t</code> and <code>#f</code>.</p></blockquote>

<p>To get you started, we've provided an implementation of the <code>if</code> special form in
the <code>do_if_form</code> function. Make sure you understand that implementation before
starting the following questions.</p>

<!-- Check out the video below for guidance on how to get started for problems 12, 13, and 14. -->
<!-- 
        <button id='toggle-16' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Hint Video<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-16">


            <iframe width="560" height="315" src="https://youtube.com/embed/3NzdKpMxSUs"
                frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe><p><a href='https://youtu.be/3NzdKpMxSUs'> YouTube link </a></p>

</div> -->


<h3 id="problem-12-2-pt">Problem 12 (2 pt)</h3>


<p>Implement <code>do_and_form</code> and <code>do_or_form</code> so that <code>and</code> and <code>or</code> expressions
(<a href="../../articles/scheme-spec/index.html#and">spec</a>) are evaluated correctly.</p>

<p>The logical forms <code>and</code> and <code>or</code> are <em>short-circuiting</em>. For <code>and</code>, your
interpreter should evaluate each sub-expression from left to right, and if any
of these is a false value, return that value. Otherwise,
return the value of the last sub-expression. If there are no
sub-expressions in an <code>and</code> expression, it evaluates to <code>#t</code>.</p>

<pre><code class="scheme">scm&gt; (and)
#t
scm&gt; (and 4 5 6)  ; all operands are true values
6
scm&gt; (and 4 5 (+ 3 3))
6
scm&gt; (and #t #f 42 (/ 1 0))  ; short&#x2d;circuiting behavior of and
#f</code></pre>



<blockquote><p>In your code here, you should represent Scheme's <code>#t</code> as Python's <code>True</code>
and Scheme's <code>#f</code> as Python's <code>False</code>.</p></blockquote>

<p>For <code>or</code>, evaluate each sub-expression from left to right. If any
sub-expression evaluates to a true value, return that value. Otherwise, return
the value of the last sub-expression.
If there are no sub-expressions in an <code>or</code> expression,
it evaluates to <code>#f</code>.</p>

<pre><code class="scheme">scm&gt; (or)
#f
scm&gt; (or 5 2 1)  ; 5 is a true value
5
scm&gt; (or #f (&#x2d; 1 1) 1)  ; 0 is a true value in Scheme
0
scm&gt; (or 4 #t (/ 1 0))  ; short&#x2d;circuiting behavior of or
4</code></pre>



<p><strong>Important:</strong> Use the provided Python functions <code>is_scheme_true</code> and
<code>is_scheme_false</code> from <code>scheme_utils.py</code> to test boolean values.</p>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 12 -u
python3 ok -q 12<button id="copy-code-python3ok-q12-upython3ok-q12" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q12-upython3ok-q12").onclick = () => copyCode('python3 ok -q 12 -u\npython3 ok -q 12', "copy-code-python3ok-q12-upython3ok-q12");
        </script>
        <br/>


        <button id='toggle-17' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q12 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-17">
  <prompt>

<pre><code>scm&gt; (and)
Choose the number of the correct choice:
  0) #t
  1) #f
  2) SchemeError
______
scm&gt; (and 1 #f)
Choose the number of the correct choice:
  0) 1
  1) #t
  2) #f
______
scm&gt; (and (+ 1 1) 1)
______
scm&gt; (and #f 5)
______
scm&gt; (and 4 5 (+ 3 3))
______
scm&gt; (not (and #t #f 42 (/ 1 0)))
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>scm&gt; (or)
Choose the number of the correct choice:
  1) #t
  0) #f
  2) SchemeError
______
scm&gt; (or (+ 1 1))
Choose the number of the correct choice:
  0) 2
  1) #f
  2) #t
______
scm&gt; (not (or #f))
______
scm&gt; (define (zero) 0)
______
scm&gt; (or (zero) 3)
______
scm&gt; (or 4 #t (/ 1 0))
______</code></pre>

<p></prompt>
</div></p>


<h3 id="problem-13-2-pt">Problem 13 (2 pt)</h3>


<p>Fill in the missing parts of <code>do_cond_form</code> so that it correctly implements
<code>cond</code> (<a href="../../articles/scheme-spec/index.html#cond">spec</a>), returning the value of the first result
sub-expression corresponding to a true predicate, or the value of the result
sub-expression corresponding to <code>else</code>.</p>

<p>Some special cases:</p>

<ul>
  <li>When the true predicate does not have a corresponding result sub-expression,
  return the predicate value.</li>
  <li>When a result sub-expression of a <code>cond</code> case has multiple expressions,
  evaluate them all and return the value of the last expression. (<em>Hint</em>: Use
  <code>eval_all</code>.)</li>
</ul>

<p>Your implementation should match the following examples and the additional tests
in <code>tests.scm</code>.</p>

<pre><code class="scheme">scm&gt; (cond ((= 4 3) &#x27;nope)
           ((= 4 4) &#x27;hi)
           (else &#x27;wait))
hi
scm&gt; (cond ((= 4 3) &#x27;wat)
           ((= 4 4))
           (else &#x27;hm))
#t
scm&gt; (cond ((= 4 4) &#x27;here (+ 40 2))
           (else &#x27;wat 0))
42</code></pre>



<p>The value of a <code>cond</code> is <code>undefined</code> if there are no true predicates and no
<code>else</code>. In such a case, <code>do_cond_form</code> should return <code>None</code>. If there is only an
<code>else</code>, return the value of its result sub-expression. If it doesn't have one,
return <code>#t</code>.</p>

<pre><code class="scheme">scm&gt; (cond (False 1) (False 2))
scm&gt; (cond (else))
#t</code></pre>



<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 13 -u
python3 ok -q 13<button id="copy-code-python3ok-q13-upython3ok-q13" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q13-upython3ok-q13").onclick = () => copyCode('python3 ok -q 13 -u\npython3 ok -q 13', "copy-code-python3ok-q13-upython3ok-q13");
        </script>
        <br/>


        <button id='toggle-18' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q13 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-18">
  <prompt>

<pre><code>scm&gt; (cond ((&gt; 2 3) 5)
....       ((&gt; 2 4) 6)
....       ((&lt; 2 5) 7)
....       (else 8))
______
scm&gt; (cond ((&gt; 2 3) 5)
....       ((&gt; 2 4) 6)
....       (else 8))
______
scm&gt; (cond ((= 1 1))
....       ((= 4 4) &#x27;huh)
....       (else &#x27;no))
______
scm&gt; (cond ((and #f 2) &#x27;whats)
....       ((and 1 #t 2))
....       ((&gt; 2 3) &#x27;going)
....       (else &#x27;on))
______</code></pre>

<p></prompt>
</div></p>


<h3 id="problem-14-2-pt">Problem 14 (2 pt)</h3>


<p>The <code>let</code> special form (<a href="../../articles/scheme-spec/index.html#let">spec</a>) binds symbols to values locally,
giving them their initial values. For example:</p>

<pre><code class="scheme">scm&gt; (define x 5)
x
scm&gt; (define y &#x27;bye)
y
scm&gt; (let ((x 42)
           (y (* x 10)))  ; this x refers to the global value of x, not 42
       (list x y))
(42 50)
scm&gt; (list x y)
(5 bye)</code></pre>



<p>Implement <code>make_let_frame</code> in <code>scheme_forms.py</code>, which returns a child
frame of <code>env</code> that binds the symbol in each element of <code>bindings</code> to the
value of its corresponding expression. The <code>bindings</code> Scheme list contains
pairs that each contain a symbol and a corresponding expression.</p>

<p>You may find the following functions and methods useful:</p>

<ul>
  <li><code>validate_form</code>: this function can be used to validate the structure of each
  binding. It takes in a Scheme list <code>expr</code> of expressions and a <code>min</code> and <code>max</code>
  length. If <code>expr</code> is not a list with length between <code>min</code> and <code>max</code> inclusive,
  it raises an error. If no <code>max</code> is passed in, the default is infinity.</li>
  <li><code>validate_formals</code>: this function validates that its argument is a
  Scheme list of symbols for which each symbol is distinct.</li>
</ul>

<blockquote><p><strong>Hint:</strong> When building new linked lists iteratively, it may be easier to build it from right to left (or end to start).</p></blockquote>

<p>Remember to refer to the <a href="../../articles/scheme-spec/index.html#let">spec</a> if you don't understand any of the test cases!</p>

<p>Use Ok to unlock and test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 14 -u
python3 ok -q 14<button id="copy-code-python3ok-q14-upython3ok-q14" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q14-upython3ok-q14").onclick = () => copyCode('python3 ok -q 14 -u\npython3 ok -q 14', "copy-code-python3ok-q14-upython3ok-q14");
        </script>
        <br/>


        <button id='toggle-19' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Q14 Unlocking Tests<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-19">
  <prompt>

<pre><code>scm&gt; (define x 1)
______
scm&gt; (let ((x 5))
....    (+ x 3))
______
scm&gt; x
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>scm&gt; (let ((a 1) (b a)) b)
Choose the number of the correct choice:
  0) x
  1) y
  2) 1
  3) SchemeError
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>scm&gt; (let ((x 5))
....    (let ((x 2)
....          (y x))
....        (+ y (* x 2))))
______</code></pre>

<p></prompt></p>

<p><prompt></p>

<pre><code>scm&gt; (let ((a 2) (a 3)) (+ a a)) ; how should we catch something like this?
______
scm&gt; (let ((y 2 3)) (+ y y)) ; should this be an allowable form?
______</code></pre>

<p></prompt>
</div></p>


<h3 id="additional-scheme-tests-1-pt">Additional Scheme Tests (1 pt)</h3>


<p>Your final task in Part III of this project is to make sure that your scheme
interpreter passes the additional suite of tests we have provided.</p>

<p>To run these tests (worth 1 point), run the command:</p>

<pre><code>python3 ok &#x2d;q tests.scm</code></pre>



<p>If you have passed all of the required cases,
you should see 1/1 points
received for <code>tests.scm</code> when you run <code>python ok &#x2d;&#x2d;score</code>.
If you are failing tests due to output from
<code>print</code> statements you've added in your code for debugging,
make sure to remove those as well for the tests to pass.</p>

<!-- **Submit your Phase 2 & 3 checkpoint** -->

<!-- Check to make sure that you completed all the problems in Phase 1:

<pre><code>python3 ok &#x2d;&#x2d;score</code></pre>

Then, submit <code>scheme_eval_apply.py</code>, <code>scheme_forms.py</code>, <code>scheme_classes.py</code>, and <code>questions.scm</code> to the **Scheme Checkpoint 2** assignment on **Gradescope** before the second checkpoint deadline.

When you run <code>ok</code> commands, you'll still see that some tests are locked
because you haven't completed the whole project yet. You'll get full credit for
the checkpoint if you complete all the problems up to this point. -->

<p>Congratulations! Your Scheme interpreter implementation is now complete!</p>


<h2 id="part-4-write-some-scheme">Part 4: Write Some Scheme</h2>


<!-- Check out this video for some hints and guidance on questions 15 through 17: -->
<!-- 
        <button id='toggle-20' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Hint Video<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-20">


            <iframe width="560" height="315" src="https://youtube.com/embed/VgQAQc9Dfh8"
                frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe><p><a href='https://youtu.be/VgQAQc9Dfh8'> YouTube link </a></p>

</div> -->

<p>Not only is your Scheme interpreter itself a tree-recursive program, but it is
flexible enough to evaluate <em>other</em> recursive programs. Implement the
following procedures in the <code>questions.scm</code> file.</p>

<p>See the <a href="../../articles/scheme-builtins/index.html">built-in procedure reference</a> for
descriptions of the behavior of all built-in Scheme procedures.</p>

<p>As you use your interpreter, you may discover additional bugs in your
interpreter implementation. Therefore, you may find it useful to test your code
for these questions in the staff interpreter or the <a href="https://code.cs61a.org/scheme">web editor</a> and then try
it in your own interpreter once you are confident your Scheme code is working.
You can also use the web editor to visualize the scheme code you've written and
help you debug.</p>


<h3 id="scheme-editor">Scheme Editor</h3>


<p>As you're writing your code, you can debug using the local Scheme Editor.
To run this editor, run <code>python3 editor</code>. This should open a window in your
browser; if it does not, please navigate to <a href="localhost:31415">localhost:31415</a>
and you should see it.</p>

<p>Make sure to run <code>python3 ok</code> in a separate tab or window so that the editor
keeps running.</p>

<p>üë©üèΩ‚Äçüíªüë®üèø‚Äçüíª <a href="../../articles/pair-programming.html">Pair programming?</a>
Remember to alternate between driver and navigator roles.
The driver controls the keyboard;
the navigator watches, asks questions, and suggests ideas.</p>


<h3 id="problem-15-2-pt">Problem 15 (2 pt)</h3>


<p>Implement the <code>enumerate</code> procedure, which takes in a list of values and returns
a list of two-element lists, where the first element is the index of the value,
and the second element is the value itself.</p>

<pre><code class="scheme">scm&gt; (enumerate &#x27;(3 4 5 6))
((0 3) (1 4) (2 5) (3 6))
scm&gt; (enumerate &#x27;())
()</code></pre>



<p>Use Ok to test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 15<button id="copy-code-python3ok-q15" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q15").onclick = () => copyCode('python3 ok -q 15', "copy-code-python3ok-q15");
        </script>
        <br/>


<h3 id="problem-16-2-pt">Problem 16 (2 pt)</h3>


<p>Implement the <code>merge</code> procedure, which takes in a comparator function <code>ordered?</code>
and two lists that are sorted according to the comparator and combines the two
lists into a single sorted list. A comparator defines an ordering by comparing
two values and returning a true value if and only if the two values are ordered.</p>

<pre><code>scm&gt; (merge &lt; &#x27;(1 4 6) &#x27;(2 5 8))
(1 2 4 5 6 8)
scm&gt; (merge &gt; &#x27;(6 4 1) &#x27;(8 5 2))
(8 6 5 4 2 1)
scm&gt; (merge &lt; &#x27;(1) &#x27;(2 3 5))
(1 2 3 5)</code></pre>

<p>In case of a tie, you can choose to break the tie in any way you wish.</p>

<p>Use Ok to test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q 16<button id="copy-code-python3ok-q16" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-q16").onclick = () => copyCode('python3 ok -q 16', "copy-code-python3ok-q16");
        </script>
        <br/>


<h2 id="extra-credit">Extra Credit</h2>


<!-- > Check out the video below for some hints on how to get started: -->

<!-- 
            <iframe width="560" height="315" src="https://youtube.com/embed/iC5_rtPpzmQ"
                frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe><p><a href='https://youtu.be/iC5_rtPpzmQ'> YouTube link </a></p> -->

<blockquote><p>During Office Hours and Project Parties, the staff will prioritize helping
students with required questions. We will not be offering help with this
question unless the <a href="https://oh.cs61a.org/">queue</a> is empty.</p></blockquote>

<p>In these series of problems, you will implement tail-call optimization, an essential feature of the
Scheme language. Watch this <a href="https://www.youtube.com/watch?v=zOxxB-gdO9U&list=PL6BsET-8jgYVSrrJ9XNFsYQButTbRFlJo">playlist</a> to learn about tail calls.</p>

<p>We will implement tail-call optimization in Scheme by using a technique called "trampolining"
to tail-call optimize our <code>scheme_eval</code> function <em>in Python</em>.</p>

<p>First, let's begin with why optimizing the <code>scheme_eval</code> function will optimize the Scheme interpreter.</p>


        <button id='toggle-21' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Why optimize scheme_eval?<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-21">
At the heart of our interpreter is <code>scheme_eval</code>, a tree recursive function. Therefore, when we
make an initial call to <code>scheme_eval</code>, a very large of recursive calls to <code>scheme_eval</code> are subsequently made.

<p>For example, consider the simple procedure:</p>

<pre><code>(define (foo n)
    (if (= n 0)
        0
        (foo (&#x2d; n 1))))</code></pre>

<p>Evaluating <code>(foo 4)</code> in our Scheme interpreter results in <code>scheme_eval</code> being called 52 times.</p>

<p>If we visualize the call of <code>scheme_eval</code> on the expression <code>(foo 4)</code>, we see an interesting pattern:</p>

<p><img class="img-responsive center-block" src="images/scheme_eval_recursion.png" alt="Diagram" width="" height=""></p>

<p>The structure of recursive calls made by <code>scheme_eval</code> closely mirrors the structure of recursive calls made by <code>foo</code>:</p>

<ul>
  <li>The call to <code>scheme_eval</code> that calculates <code>(foo 4)</code> eventually makes a recursive call to <code>scheme_eval</code> that
  calculates <code>(foo 3)</code>. The call to <code>scheme_eval</code> that calculates <code>(foo 3)</code> eventually makes a recursive call
  to <code>scheme_eval</code> that calculates <code>(foo 2)</code>, and so on.</li>
  <li>In the <code>foo</code> function in Scheme, the very last action in the call to <code>(foo 4)</code> is a recursive call to <code>(foo 3)</code>. Similarly, in Python, the very last action in the <code>scheme_eval</code> call for <code>(foo 4)</code> is a recursive call to <code>scheme_eval</code> for <code>(foo 3)</code>.
  <em>In other words, these <code>scheme_eval</code> calls are tail calls!</em></li>
</ul>

<p>In Python, a large number of <code>scheme_eval</code> frames are opened and kept. Each of these <code>scheme_eval</code> frames holds a
<em>reference</em> to a <code>foo</code> frame from the previous call (represented by an instance of the <code>Frame</code> class) through the <code>env</code> parameter. Because our current interpreter implementation keeps the <code>scheme_eval</code> frames open to return to once everything is evaluated, it also keeps all these unnecessary <code>foo</code> frames open.</p>

<p>However, because some of the <code>scheme_eval</code> calls are tail calls, we actually don't need to keep all of those <code>scheme_eval</code> frames that are being
created in Python. By tail-call optimizing <code>scheme_eval</code>, we can eliminate these unnecessary frames. And since the Scheme frames are
stored within the <code>scheme_eval</code> call frames, tail-call optimizing <code>scheme_eval</code> in Python will automatically tail-call optimize the entire
interpreter in Scheme (yay!).</p>

<p>As it turns out, tail-call optimizing <code>scheme_eval</code> has other effects in addition to tail-call optimizing Scheme.
For example, expressions like <code>(or #f (or #f (or #f f )))</code> also become much more efficient to run (which we will explores in one of the subparts).
</div></p>

<br>


        <button id='toggle-22' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Tail Calls<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-22">
Here is a simple recursive procedure, <code>foo</code>, that doesn't do very much.

<pre><code>(define (foo n)
    (if (= n 0)
        0
        (foo (&#x2d; n 1))))</code></pre>

<p>In your non-tail-call optimized version of Scheme, here's what happens when call we <code>foo(4)</code>:</p>

<p><img class="img-responsive center-block" src="images/tco.gif" alt="Foo" width="" height=""></p>

<p>In order to calculate <code>(foo 4)</code>, we need to call <code>(foo 3)</code>. In order to calculate <code>(foo 3)</code>,
we need to call <code>(foo 2)</code>. In order to calculate <code>(foo 2)</code>, we need to call <code>(foo 1)</code>. In order
to calculate <code>(foo 1)</code>, we need to call <code>(foo 0)</code>, which returns <code>0</code>.</p>

<p>While all of these recursive calls are happening, each call <em>waits</em> on the result of the next recursive
call, and its frame remains open during that time. This is manageable for small inputs, but for <code>(foo 1000000)</code>,
over 1 million frames will be simultaneously open at some point! That could crash your computer.</p>

<p>In most circumstances, this practice of keeping these frames active during subsequent procedure calls is important.
For example, in the below code, the procedure <code>f</code> calls <code>g</code>. The frame of <code>f</code> <em>needs</em> to remain active while the call
to <code>g</code> is ongoing, so that we can eventually return to <code>f</code> and complete its execution using the result from <code>g</code>.</p>

<pre><code>(define (f x)
    (define y (g x))
    (* x y))

(define (g x)
   (* 6 x))

(f 7)</code></pre>

<p>However, some procedures, such as <code>foo</code>, make their procedure calls only at the <em>very very end</em>.
Because the very last thing <code>(foo 4)</code> does is make a call to <code>(foo 3)</code>, there will be nothing left to do
in the <code>(foo 4)</code> call after <code>(foo 3)</code> returns.</p>

<p>Therefore, we do not need to actually keep around the <code>(foo 4)</code> frame once we have made the recursive call to <code>(foo 3)</code>.
Our interpreter is currently saving these frames, even though they are redundant. If we could get rid of these frames
when we are done with them, we would solve the issue of large inputs to <code>foo</code> crashing and dramatically improve the efficiency
of our program.</p>

<p>In the situation where a call is the last thing a procedure evaluates before it returns, that call is said to
be in a <strong>tail context</strong>. Full implementations of Scheme all implement <strong>tail-call optimization</strong>, which involves
discarding unnecessary frames so that <strong>tail calls</strong> run more efficiently.
</div></p>

<br>


        <button id='toggle-23' class='btn btn-outline btn-lg alwaystoggle toggle'>
        Trampolining<noscript> (enable JavaScript)</noscript>
        </button>
        <div class="solution toggle-23">
Trampolining is a method of implementing tail-call optimization in a language that does not normally
support it (e.g. Python) by storing function calls that are in a tail context as unevaluated calls (Thunks),
then evaluating and unwrapping them only as needed (Trampolining).

<p>The basic unit of this method is the Thunk, which represents an unevaluated operation. The easiest way to create
a Thunk and simulate an unevaluated operation is by wrapping the operation in a zero-argument function and saving it
for later evaluation.</p>

<pre><code>&gt;&gt;&gt; my_thunk1 = lambda: sqrt(16384) + 22
&gt;&gt;&gt; my_thunk2 = lambda: some_costly_operation(1000)</code></pre>

<p>In the first Thunk, we wrap the operation <code>sqrt(16384) + 22</code> in a zero-argument lambda function and save it to the variable <code>my_thunk1</code>.
In the second Thunk, we wrap <code>some_costly_operation(1000)</code> in a zero-argument lambda function and save it to the variable <code>my_thunk2</code>.</p>

<p>These Thunks can be "unwrapped" later by calling the variable where the zero-argument function was saved, which will then evaluate the operation
inside.</p>

<pre><code>&gt;&gt;&gt; my_thunk1()
150.0
&gt;&gt;&gt; my_thunk2()
# result of evaluating some_costly_operation(1000)</code></pre>

<p>Thunks can be nested as well, which will require multiple calls to unwrap:</p>

<pre><code>&gt;&gt;&gt; my_nested_thunk = lambda: lambda: lambda: 4 * (2 + 3)
&gt;&gt;&gt; thunk2 = my_nested_thunk()
&gt;&gt;&gt; thunk3 = thunk2()
&gt;&gt;&gt; result = thunk3()
&gt;&gt;&gt; result
20</code></pre>

<p>This "unwrapping" of a nested thunk can be done automatically by repeatedly calling the thunk until it finally returns a value.
This is the process we call trampolining.</p>

<pre><code>def trampoline(value):
    while callable(value): # While value is still a thunk
        value = value()
    return value</code></pre>

<p>Why is this useful? Consider our Python tail-call-optimized factorial:</p>

<pre><code>def tail_factorial(n, so_far=1):
    if n == 0:
        return so_far
    return tail_factorial(n &#x2d; 1, so_far * n)</code></pre>

<p>While the Scheme version of <code>tail_factorial</code> would be tail-call-optimized, recall that Python does not optimize tail calls.
In this Python version of <code>tail_factorial</code>, a frame is opened at each recursive call and only closed at the very end, causing
this to be as inefficient as the original <code>factorial</code> implementation in Python without tail calls! Visualizing this as a call stack:</p>

<p><img class="img-responsive center-block" src="images/non_thunked_calls.png" alt="Non-Thunk Calls" width="" height=""></p>

<p>Observe that by the time we get to the base case, every single <code>tail_factorial</code> frame is still open.
To fix this, we can apply thunking!</p>

<p>The implementation looks like this:</p>

<pre><code>def thunk_factorial(n, so_far=1):
    def thunk():
        if n == 0:
            return so_far
        return thunk_factorial(n &#x2d; 1, so_far * n)
    return thunk

def factorial(n):
    value = thunk_factorial(n)
    while callable(value): # While value is still a thunk
        value = value()
    return value</code></pre>

<p>Thunking keeps only one <code>thunk_factorial</code> frame open by having each call evaluate exactly one step of the factorial. Instead of making and returning another nested call (like in <code>tail_factorial</code> with <code>return tail_factorial(n &#x2d; 1, so_far * n)</code>), <code>thunk_factorial</code> returns an <em>unevaluated</em> thunk. Think about how the mutual recursion in <code>thunk_factorial</code> achieves this!</p>

<p>Now, with <code>factorial</code>, we apply trampolining and unravel <code>thunk_factorial</code> until we get the final answer.</p>

<p>With these 2 functions, we no longer keep every frame at each recursive call open!</p>

<p>To visualize the benefit, consider the new diagram of the function calls,
and compare to the original tail recursive version:</p>

<p><img class="img-responsive center-block" src="images/thunked_calls.png" alt="Thunk Calls" width="" height=""></p>

<p>While the thunked version may initially seem more complicated, notice that there are always at most
one <code>thunk_factorial</code> and <code>thunk</code> calls active at a time. This is true no matter how large <code>n</code> gets!
At each step, calling the current <code>thunk</code> calculates exactly one step of the factorial, then returns
a new <code>thunk</code> for the next step so that the process can continue in the next loop.</p>

<p>You can also take a closer look by observing this step-by-step diagram that walks through
evaluating the first part of <code>factorial(3)</code>:</p>

<p><img class="img-responsive center-block" src="images/thunk_detailed.gif" alt="Detailed Animated Thunk" width="" height=""></p>

<p>Notice that by returning an unevaluated thunk from <code>thunk_factorial</code> instead of making a recursive call,
completed frames can close rather than stay open waiting for the recursive call they made to return. This way,
only the necessary frames remain open at any given time.</p>

<p>For our Scheme interpreter, an <code>Unevaluated</code> instance is a thunk of <code>scheme_eval</code>, the function we want to optimize.
We repeatedly evaluate this thunk by calling <code>scheme_eval</code> on the stored arguments, until we get a value
(which we return).</p>

<br>

</div>

<br><br>


<h3 id="problem-ec-4-pts">Problem EC (4 pts)</h3>


<blockquote><p><strong>Preface</strong>: This question is challenging and requires you to modify multiple areas in the interpreter without specifying where.
<strong>We recommend taking the time to thoroughly understand all the concepts and develop a clear strategy before beginning to code.</strong></p></blockquote>

<!-- separate block quotes -->

<blockquote><p><strong>Important</strong>: While working, continuously ensure that the code you write for this question does not cause other parts of the project to fail.
If you find yourself losing track of your edits, it might be a good idea to save a copy of your original code for reference.</p></blockquote>

<p>Complete the function <code>optimize_tail_calls</code> in <code>scheme_eval_apply.py</code>. It returns an
alternative to <code>scheme_eval</code> that is tail-call optimized in Python. That is, it will
allow an unbounded number of active tail calls to <code>scheme_eval</code> in constant
space. It has a third argument <code>tail</code> that indicates whether the call to <code>scheme_eval</code> is
a tail call or not.</p>

<p>The <code>Unevaluated</code> class represents an expression that needs to be evaluated in a specific environment.
When <code>optimized_eval</code> receives a non-atomic expression in a tail context, it returns an instance of <code>Unevaluated</code>.
Otherwise, <code>optimized_eval</code> should keep calling <code>unoptimized_scheme_eval</code> on the current <code>expr</code> and <code>env</code> until the
result is a final value, rather than an <code>Unevaluated</code> instance.</p>

<p>After you are done implementing <code>optimize_tail_calls</code>, uncomment the following line in <code>scheme_eval_apply.py</code>
to reassign the original <code>scheme_eval</code> to the optimized implementation:</p>

<pre><code>scheme_eval = optimize_tail_calls(scheme_eval)</code></pre>

<p>Finally, identify which calls to <code>scheme_eval</code> in your interpreter are tail calls. Modify those <code>scheme_eval</code> tail calls to pass in True
as the third argument (the <code>tail</code> parameter) whenever applicable.</p>

<blockquote><p><strong>Note</strong>: A successful implementation will require changes to <em>several other functions</em>, including some functions that we provided for you.</p></blockquote>

<!-- separate block quotes -->

<blockquote><p><strong>Hints</strong>:</p>

<p>A call to <code>scheme_eval</code> is a tail call if it is the last thing to be done in a function
before it returns.</p>

<p>Even within a function, not every call to <code>scheme_eval</code> will benefit from tail-call optimization. Consider which specific calls will
benefit and pass True for the <code>tail</code> argument accordingly.</p></blockquote>

<p>Use Ok to test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q EC<button id="copy-code-python3ok-qEC" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-qEC").onclick = () => copyCode('python3 ok -q EC', "copy-code-python3ok-qEC");
        </script>
        <br/>


<h3 id="optional-problem-0-pt">Optional Problem (0 pt)</h3>


<p>In Scheme, source code is data. Every non-atomic expression is written as a Scheme list, so we can write procedures that manipulate other programs just as we write procedures that manipulate lists.</p>

<p>Rewriting programs can be useful: we can write an interpreter that only handles a small core of the language, and then write a procedure that converts other special forms into the core language before a program is passed to the interpreter.</p>

<p>For example, the <code>let</code> special form is equivalent to a call expression that begins with a <code>lambda</code> expression. Both create a new frame extending the current environment and evaluate a body within that new environment.</p>

<pre><code class="scheme">(let ((a 1) (b 2)) (+ a b))
;; Is equivalent to:
((lambda (a b) (+ a b)) 1 2)</code></pre>



<p>These expressions can be represented by the following diagrams:</p>



        <div class="table-responsive">
          <table class="table table-bordered">
          
  <tr>
    <th>Let</th>
    <th>Lambda</th>
  </tr>
  <tr>
    <td><img class="img-responsive center-block" src="images/let.png" alt="let" width="" height=""></td>
    <td><img class="img-responsive center-block" src="images/lambda.png" alt="lambda" width="" height=""></td>
  </tr>

          </table>
        </div>
        



<p>Use this rule to implement a procedure called <code>let&#x2d;to&#x2d;lambda</code> in <code>questions.scm</code> that rewrites all <code>let</code> special forms into <code>lambda</code> expressions. If we quote a <code>let</code> expression and pass it into this procedure, an equivalent <code>lambda</code> expression should be returned:</p>

<pre><code class="scheme">scm&gt; (let&#x2d;to&#x2d;lambda &#x27;(let ((a 1) (b 2)) (+ a b)))
((lambda (a b) (+ a b)) 1 2)
scm&gt; (let&#x2d;to&#x2d;lambda &#x27;(let ((a 1)) (let ((b a)) b)))
((lambda (a) ((lambda (b) b) a)) 1)
scm&gt; (let&#x2d;to&#x2d;lambda 1)
1
scm&gt; (let&#x2d;to&#x2d;lambda &#x27;a)
a</code></pre>



<p>In order to handle all programs, <code>let&#x2d;to&#x2d;lambda</code> must be aware of Scheme syntax. Since Scheme expressions are recursively nested, <code>let&#x2d;to&#x2d;lambda</code> must also be recursive. In fact, the structure of <code>let&#x2d;to&#x2d;lambda</code> is somewhat similar to that of <code>scheme_eval</code>‚Äîbut in Scheme! As a reminder, atoms include numbers, booleans, <code>nil</code>, and symbols. You do not need to consider code that contains quasiquotation for this problem.</p>

<pre><code class="scheme">(define (let&#x2d;to&#x2d;lambda expr)
  (cond ((atom?   expr) &lt;rewrite atoms&gt;)
        ((quoted? expr) &lt;rewrite quoted expressions&gt;)
        ((lambda? expr) &lt;rewrite lambda expressions&gt;)
        ((define? expr) &lt;rewrite define expressions&gt;)
        ((let?    expr) &lt;rewrite let expressions&gt;)
        (else           &lt;rewrite other expressions&gt;)))</code></pre>



<p><em>Hint 1</em>: Consider how you can use <code>map</code> to convert <code>let</code> forms in every element of a list to the equivalent <code>lambda</code> form? Consider using <code>zip</code>:</p>

<pre><code class="scheme">scm&gt; (zip &#x27;((1 2) (3 4) (5 6)))
((1 3 5) (2 4 6))
scm&gt; (zip &#x27;((1 2)))
((1) (2))
scm&gt; (zip &#x27;())
(() ())</code></pre>



<p><em>Hint 2</em>: In this problem, it may be helpful to build a Scheme list that evaluates to a special form (for instance, a <code>lambda</code> expression). As a related example, the following code builds a scheme list that evaluates to the expression <code>(define (f x) (+ x 1))</code>:</p>

<pre><code class="scheme">(let ((name&#x2d;and&#x2d;params &#x27;(f x))
      (body &#x27;(+ x 1)))
  (cons &#x27;define
        (cons name&#x2d;and&#x2d;params (cons body nil))))</code></pre>



<p>Use Ok to test your code:</p><pre style="margin-bottom:0;"><code class="nohighlight">python3 ok -q optional<button id="copy-code-python3ok-qoptional" class="inline-copy-button"><div class="copy-tooltip"><span>Copy</span></div>‚úÇÔ∏è</a></code></pre>
        <script>
        document.getElementById("copy-code-python3ok-qoptional").onclick = () => copyCode('python3 ok -q optional', "copy-code-python3ok-qoptional");
        </script>
        <br/>

<blockquote><p>We used let while defining <code>let&#x2d;to&#x2d;lambda</code>. What if we want to run <code>let&#x2d;to&#x2d;lambda</code> on an interpreter that does not recognize <code>let</code>? We can pass <code>let&#x2d;to&#x2d;lambda</code> to itself to rewrite itself into an <em>equivalent program without</em> <code>let</code>:</p>

<pre><code class="scheme">;; The let&#x2d;to&#x2d;lambda procedure
(define (let&#x2d;to&#x2d;lambda expr)
 ...)

;; A list representing the let&#x2d;to&#x2d;lambda procedure
(define let&#x2d;to&#x2d;lambda&#x2d;code
 &#x27;(define (let&#x2d;to&#x2d;lambda expr)
    ...))

;; A let&#x2d;to&#x2d;lambda procedure that does not use &#x27;let&#x27;!
(define let&#x2d;to&#x2d;lambda&#x2d;without&#x2d;let
 (let&#x2d;to&#x2d;lambda let&#x2d;to&#x2d;lambda&#x2d;code))</code></pre></blockquote>


<h2 id="conclusion">Conclusion</h2>


<p><strong>Congratulations!</strong> You have just implemented an interpreter for an entire
language! If you enjoyed this project and want to extend it further, you may be
interested in looking at more advanced features, like <a href="http://schemers.org/Documents/Standards/R5RS/HTML/r5rs-Z-H-7.html#%_sec_4.2.2">let* and letrec</a>,
<a href="http://schemers.org/Documents/Standards/R5RS/HTML/r5rs-Z-H-7.html#%_sec_4.2.6">unquote splicing</a>, <a href="https://en.wikipedia.org/wiki/Stack_trace">error tracing</a>, and <a href="https://en.wikipedia.org/wiki/Call-with-current-continuation">continuations</a>.</p>


<h2 id="project-submission">Project Submission</h2>


<p>Run <code>ok</code> on all problems to make sure all tests are unlocked and pass:</p>

<pre><code>python3 ok</code></pre>

<p>You can also check your score on each part of the project:</p>

<pre><code>python3 ok &#x2d;&#x2d;score</code></pre>

<p>Once you are satisfied, submit <code>scheme_eval_apply.py</code>, <code>scheme_forms.py</code>, <code>scheme_classes.py</code>, and <code>questions.scm</code> to the <strong>Scheme</strong> assignment on <strong>Gradescope</strong> before the second checkpoint deadline.</p>

<p>You can add a partner to your Gradescope submission by clicking on <strong>+ Add Group Member</strong> under your name on the right hand side of your submission. Only one partner needs to submit to Gradescope.</p>

<script>
/*
This code is duplicated in lab-check-in.html. Doesn't work if we move it to a separate
file because of JQuery document ready concurrency issues.
*/
$(function() {
    $('.alwaystoggle').css('display', 'inline-block');
    $('.alwaystoggle').click(function() {
      var solution_id = $(this).attr('id');
      $('div.' + solution_id).slideToggle(600);
    });
});
</script>

<script>
$("#cats_typing").hover(
  function() {
    $("#cats_typing").attr("src", "images/cats_typing.gif");
  },
  function() {
    $("#cats_typing").attr("src", "images/cats_typing_still.gif");
  }
);
</script>



  </div>

  <div class='col-md-3 sticky'>
    <nav class='hidden-print hidden-sm hidden-xs sidebar'>
      <ul>
  <li><a href="../scheme.html#introduction">Introduction</a></li>
  <li><a href="../scheme.html#download-starter-files">Download starter files</a></li>
  <li><a href="../scheme.html#logistics">Logistics</a></li>
  <li><a href="../scheme.html#interpreter-details">Interpreter details</a></li>
  <ul>
    <li><a href="../scheme.html#scheme-features">Scheme features</a></li>
    <li><a href="../scheme.html#running-the-interpreter">Running the interpreter</a></li>
  </ul>
  <li><a href="../scheme.html#getting-started-videos">Getting Started Videos</a></li>
  <li><a href="../scheme.html#part-1-the-evaluator">Part 1: The Evaluator</a></li>
  <ul>
    <li><a href="../scheme.html#problem-1-1-pt">Problem 1 (1 pt)</a></li>
    <li><a href="../scheme.html#problem-2-2-pt">Problem 2 (2 pt)</a></li>
    <li><a href="../scheme.html#problem-3-2-pt">Problem 3 (2 pt)</a></li>
    <li><a href="../scheme.html#problem-4-2-pt">Problem 4 (2 pt)</a></li>
    <li><a href="../scheme.html#problem-5-1-pt">Problem 5 (1 pt)</a></li>
  </ul>
  <li><a href="../scheme.html#part-2-procedures">Part 2: Procedures</a></li>
  <ul>
    <li><a href="../scheme.html#problem-6-1-pt">Problem 6 (1 pt)</a></li>
    <li><a href="../scheme.html#user-defined-procedures">User-Defined Procedures</a></li>
    <li><a href="../scheme.html#problem-7-2-pt">Problem 7 (2 pt)</a></li>
    <li><a href="../scheme.html#problem-8-2-pt">Problem 8 (2 pt)</a></li>
    <li><a href="../scheme.html#problem-9-2-pt">Problem 9 (2 pt)</a></li>
    <li><a href="../scheme.html#problem-10-2-pt">Problem 10 (2 pt)</a></li>
    <li><a href="../scheme.html#problem-11-2-pt">Problem 11 (2 pt)</a></li>
    <li><a href="../scheme.html#submit-your-phase-1-amp-2-checkpoint">Submit your Phase 1 &amp; 2 checkpoint</a></li>
  </ul>
  <li><a href="../scheme.html#part-3-special-forms">Part 3: Special Forms</a></li>
  <ul>
    <li><a href="../scheme.html#problem-12-2-pt">Problem 12 (2 pt)</a></li>
    <li><a href="../scheme.html#problem-13-2-pt">Problem 13 (2 pt)</a></li>
    <li><a href="../scheme.html#problem-14-2-pt">Problem 14 (2 pt)</a></li>
    <li><a href="../scheme.html#additional-scheme-tests-1-pt">Additional Scheme Tests (1 pt)</a></li>
  </ul>
  <li><a href="../scheme.html#part-4-write-some-scheme">Part 4: Write Some Scheme</a></li>
  <ul>
    <li><a href="../scheme.html#scheme-editor">Scheme Editor</a></li>
    <li><a href="../scheme.html#problem-15-2-pt">Problem 15 (2 pt)</a></li>
    <li><a href="../scheme.html#problem-16-2-pt">Problem 16 (2 pt)</a></li>
  </ul>
  <li><a href="../scheme.html#extra-credit">Extra Credit</a></li>
  <ul>
    <li><a href="../scheme.html#problem-ec-4-pts">Problem EC (4 pts)</a></li>
    <li><a href="../scheme.html#optional-problem-0-pt">Optional Problem (0 pt)</a></li>
  </ul>
  <li><a href="../scheme.html#conclusion">Conclusion</a></li>
  <li><a href="../scheme.html#project-submission">Project Submission</a></li>
</ul>
    </nav>
  </div>
</div>

    </main>

    <!-- <footer class="container">
      <div class="row text-center">
        <div class="col col-sm-4">
          <h3><a href="/">CS 61A</a></h3>
          <ul class="nav nav-pills nav-stacked">
            <li><a href="/weekly">Weekly Schedule</a></li>
            <li><a href="/office-hours">Office Hours</a></li>
            <li><a href="/staff">Staff</a></li>
          </ul>
        </div>
        <div class="col col-sm-4">
          <h3><a href="/resources">Resources</a></h3>
          <ul class="nav nav-pills nav-stacked">
            <li><a href="/articles/studying">Studying Guide</a></li>
            <li><a href="/articles/debugging">Debugging Guide</a></li>
            <li><a href="/articles/composition">Composition Guide</a></li>
            <li><a href="/articles/pair-programming">Pair Programming</a></li>
          </ul>
        </div>
        <div class="col col-sm-4">
          <h3><a href="/articles/about">Policies</a></h3>
          <ul class="nav nav-pills nav-stacked">
            <li><a href="/articles/about#assignments">Assignments</a></li>
            <li><a href="/articles/about#exams">Exams</a></li>
            <li><a href="/articles/about#grading">Grading</a></li>
          </ul>
        </div>
      </div>
    </footer> -->

    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/loader.min.js"></script>
  <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/editor/editor.main.min.css">
  <script>
      require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs' }});
      window.MonacoEnvironment = { getWorkerUrl: () => URL.createObjectURL(new Blob([`
      self.MonacoEnvironment = {
          baseUrl: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min'
      };
      importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/base/worker/workerMain.min.js');
  `], { type: 'text/javascript' }))
  };
  </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.5/js/jsplumb.min.js"></script>
    <script src="../../assets/js/network_storage.js"></script>
    <script src="../../assets/js/storable.js"></script>
    <script src="../../assets/js/editor.js"></script>
    <script src="../../assets/js/copy-button.js"></script>
    <script src="../../assets/js/env-diagram.js"></script>
    
<!-- <script src="/assets/js/sketchy.js"></script> -->
<script>
  $('.sidebar ul').addClass('nav nav-stacked noselect');
  $('body').scrollspy({
    target: '.sidebar',
    offset: 40
  });

  function goToId(id) {
    var target = $(id);
    target.parent().show();
    $('html,body').animate({
      scrollTop: target.offset().top,
    }, 100);
    $("body").scrollspy('refresh');
  }

  if (location.hash) {
    setTimeout(function() {
      if (location.hash) {
        goToId(location.hash);
      }
    }, 1);
  }

  $("a").click(function(event) {
    var urlBeforeHashRegEx = new RegExp("^"+window.location.href.split("#")[0]);
    if (/^#/.test(this.hash) && urlBeforeHashRegEx.test(this.href)) {
      event.preventDefault();
      goToId(this.hash);
      document.location.hash = this.hash;
    }
  });
</script>

  </body>
</html>